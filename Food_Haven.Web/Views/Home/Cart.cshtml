@model List<Repository.ViewModels.CartViewModels>
<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <title>Nest - Multipurpose eCommerce HTML Template</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="~/assets/imgs/theme/favicon.svg">
    <!-- Template CSS -->
    <link rel="stylesheet" href="~/assets/css/main.css?v=6.0">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="chrome-extension://mooikfkahbdckldjjndioackbalphokd/~/assets/prompt.js"></script>
    @Html.Raw(" <link href='https://cdn.jsdelivr.net/npm/@flaticon/flaticon-uicons/css/all/all.css' rel='stylesheet'>")

    <link rel="stylesheet" href="~/assets/js/gridjs/theme/mermaid.min.css">
    <style>
        /* ƒê·∫£m b·∫£o v·ªã tr√≠ t∆∞∆°ng ƒë·ªëi cho ·∫£nh */
        .product-thumbnail {
            position: relative;
        }

        /* 1. L√†m m·ªù v√† v√¥ hi·ªáu h√≥a t∆∞∆°ng t√°c khi c√≥ class 'outofstock' */
        .outofstock {
            opacity: 0.5;
            /* L√†m m·ªù to√†n b·ªô d√≤ng */
            pointer-events: none;
            /* Kh√¥ng cho t∆∞∆°ng t√°c */
        }

        /* CSS chung cho layout */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        .product-name a {
            text-decoration: none;
            color: #333;
        }
        /* C·∫≠p nh·∫≠t tr·∫°ng th√°i l√†m m·ªù */
        .outofstock .qty-up {
            pointer-events: none; /* V√¥ hi·ªáu h√≥a n√∫t tƒÉng */
        }

        .outofstock .qty-down {
            pointer-events: auto; /* Cho ph√©p ng∆∞·ªùi d√πng gi·∫£m s·ªë l∆∞·ª£ng */
        }

        .out-of-stock-label {
            color: red;
            font-weight: bold;
            font-size: 14px;
            display: block;
        }
    </style>

</head>

<body>

    @await Html.PartialAsync("_Header")

    <div class="mobile-header-active mobile-header-wrapper-style">
        <div class="mobile-header-wrapper-inner">
            <div class="mobile-header-top">
                <div class="mobile-header-logo">
                    <a href="index.html"><img src="~/assets/imgs/theme/logo.svg" alt="logo"></a>
                </div>
                <div class="mobile-menu-close close-style-wrap close-style-position-inherit">
                    <button class="close-style search-close">
                        <i class="icon-top"></i>
                        <i class="icon-bottom"></i>
                    </button>
                </div>
            </div>
            <div class="mobile-header-content-area">
                <div class="mobile-search search-style-3 mobile-header-border">
                    <form action="#">
                        <input type="text" placeholder="Search for items‚Ä¶">
                        <button type="submit"><i class="fi-rs-search"></i></button>
                    </form>
                </div>
                <div class="mobile-menu-wrap mobile-header-border">
                    <!-- mobile menu start -->
                    <nav>
                        <ul class="mobile-menu font-heading">
                            <li class="menu-item-has-children">
                                <a href="index.html">Home</a>
                                <ul class="dropdown">
                                    <li><a href="index.html">Home 1</a></li>
                                    <li><a href="index-2.html">Home 2</a></li>
                                    <li><a href="index-3.html">Home 3</a></li>
                                    <li><a href="index-4.html">Home 4</a></li>
                                    <li><a href="index-5.html">Home 5</a></li>
                                    <li><a href="index-6.html">Home 6</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children">
                                <a href="shop-grid-right.html">shop</a>
                                <ul class="dropdown">
                                    <li><a href="shop-grid-right.html">Shop Grid ‚Äì Right Sidebar</a></li>
                                    <li><a href="shop-grid-left.html">Shop Grid ‚Äì Left Sidebar</a></li>
                                    <li><a href="shop-list-right.html">Shop List ‚Äì Right Sidebar</a></li>
                                    <li><a href="shop-list-left.html">Shop List ‚Äì Left Sidebar</a></li>
                                    <li><a href="shop-fullwidth.html">Shop - Wide</a></li>
                                    <li class="menu-item-has-children">
                                        <a href="#">Single Product</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Product ‚Äì Right Sidebar</a></li>
                                            <li><a href="shop-product-left.html">Product ‚Äì Left Sidebar</a></li>
                                            <li><a href="shop-product-full.html">Product ‚Äì No sidebar</a></li>
                                            <li><a href="shop-product-vendor.html">Product ‚Äì Vendor Infor</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="shop-filter.html">Shop ‚Äì Filter</a></li>
                                    <li><a href="shop-wishlist.html">Shop ‚Äì Wishlist</a></li>
                                    <li><a href="shop-cart.html">Shop ‚Äì Cart</a></li>
                                    <li><a href="shop-checkout.html">Shop ‚Äì Checkout</a></li>
                                    <li><a href="shop-compare.html">Shop ‚Äì Compare</a></li>
                                    <li class="menu-item-has-children">
                                        <a href="#">Shop Invoice</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-invoice-1.html">Shop Invoice 1</a></li>
                                            <li><a href="shop-invoice-2.html">Shop Invoice 2</a></li>
                                            <li><a href="shop-invoice-3.html">Shop Invoice 3</a></li>
                                            <li><a href="shop-invoice-4.html">Shop Invoice 4</a></li>
                                            <li><a href="shop-invoice-5.html">Shop Invoice 5</a></li>
                                            <li><a href="shop-invoice-6.html">Shop Invoice 6</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children">
                                <a href="#">Vendors</a>
                                <ul class="dropdown">
                                    <li><a href="vendors-grid.html">Vendors Grid</a></li>
                                    <li><a href="vendors-list.html">Vendors List</a></li>
                                    <li><a href="vendor-details-1.html">Vendor Details 01</a></li>
                                    <li><a href="vendor-details-2.html">Vendor Details 02</a></li>
                                    <li><a href="vendor-dashboard.html">Vendor Dashboard</a></li>
                                    <li><a href="vendor-guide.html">Vendor Guide</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children">
                                <a href="#">Mega menu</a>
                                <ul class="dropdown">
                                    <li class="menu-item-has-children">
                                        <a href="#">Women's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Dresses</a></li>
                                            <li><a href="shop-product-right.html">Blouses & Shirts</a></li>
                                            <li><a href="shop-product-right.html">Hoodies & Sweatshirts</a></li>
                                            <li><a href="shop-product-right.html">Women's Sets</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children">
                                        <a href="#">Men's Fashion</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Jackets</a></li>
                                            <li><a href="shop-product-right.html">Casual Faux Leather</a></li>
                                            <li><a href="shop-product-right.html">Genuine Leather</a></li>
                                        </ul>
                                    </li>
                                    <li class="menu-item-has-children">
                                        <a href="#">Technology</a>
                                        <ul class="dropdown">
                                            <li><a href="shop-product-right.html">Gaming Laptops</a></li>
                                            <li><a href="shop-product-right.html">Ultraslim Laptops</a></li>
                                            <li><a href="shop-product-right.html">Tablets</a></li>
                                            <li><a href="shop-product-right.html">Laptop Accessories</a></li>
                                            <li><a href="shop-product-right.html">Tablet Accessories</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children">
                                <a href="blog-category-fullwidth.html">Blog</a>
                                <ul class="dropdown">
                                    <li><a href="blog-category-grid.html">Blog Category Grid</a></li>
                                    <li><a href="blog-category-list.html">Blog Category List</a></li>
                                    <li><a href="blog-category-big.html">Blog Category Big</a></li>
                                    <li><a href="blog-category-fullwidth.html">Blog Category Wide</a></li>
                                    <li class="menu-item-has-children">
                                        <a href="#">Single Product Layout</a>
                                        <ul class="dropdown">
                                            <li><a href="blog-post-left.html">Left Sidebar</a></li>
                                            <li><a href="blog-post-right.html">Right Sidebar</a></li>
                                            <li><a href="blog-post-fullwidth.html">No Sidebar</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children">
                                <a href="#">Pages</a>
                                <ul class="dropdown">
                                    <li><a href="page-about.html">About Us</a></li>
                                    <li><a href="page-contact.html">Contact</a></li>
                                    <li><a href="page-account.html">My Account</a></li>
                                    <li><a href="page-login.html">Login</a></li>
                                    <li><a href="page-register.html">Register</a></li>
                                    <li><a href="page-forgot-password.html">Forgot password</a></li>
                                    <li><a href="page-reset-password.html">Reset password</a></li>
                                    <li><a href="page-purchase-guide.html">Purchase Guide</a></li>
                                    <li><a href="page-privacy-policy.html">Privacy Policy</a></li>
                                    <li><a href="page-terms.html">Terms of Service</a></li>
                                    <li><a href="page-404.html">404 Page</a></li>
                                </ul>
                            </li>
                            <li class="menu-item-has-children">
                                <a href="#">Language</a>
                                <ul class="dropdown">
                                    <li><a href="#">English</a></li>
                                    <li><a href="#">French</a></li>
                                    <li><a href="#">German</a></li>
                                    <li><a href="#">Spanish</a></li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                    <!-- mobile menu end -->
                </div>
                <div class="mobile-header-info-wrap">
                    <div class="single-mobile-header-info">
                        <a href="page-contact.html"><i class="fi-rs-marker"></i> Our location </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="page-login.html"><i class="fi-rs-user"></i>Log In / Sign Up </a>
                    </div>
                    <div class="single-mobile-header-info">
                        <a href="#"><i class="fi-rs-headphones"></i>(+01) - 2345 - 6789 </a>
                    </div>
                </div>
                <div class="mobile-social-icon mb-50">
                    <h6 class="mb-15">Follow Us</h6>
                    <a href="#"><img src="~/assets/imgs/theme/icons/icon-facebook-white.svg" alt=""></a>
                    <a href="#"><img src="~/assets/imgs/theme/icons/icon-twitter-white.svg" alt=""></a>
                    <a href="#"><img src="~/assets/imgs/theme/icons/icon-instagram-white.svg" alt=""></a>
                    <a href="#"><img src="~/assets/imgs/theme/icons/icon-pinterest-white.svg" alt=""></a>
                    <a href="#"><img src="~/assets/imgs/theme/icons/icon-youtube-white.svg" alt=""></a>
                </div>
                <div class="site-copyright"> Copyright 2024 ¬© Nest. All rights reserved. Powered by AliThemes.</div>
            </div>
        </div>
    </div>
    <!--End header-->
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="index.html" rel="nofollow"><i class="fi-rs-home mr-5"></i>Home</a>
                    <span></span> Shop
                    <span></span> Cart
                </div>
            </div>
        </div>
        <div class="container mb-80 mt-50">
            <div class="row">
                <div class="col-lg-8 mb-40">
                    <h1 class="heading-2 mb-10">Your Cart</h1>
                    <div class="d-flex justify-content-between">
                        <h6 class="text-body">There are <span class="text-brand">@Model.Count</span> products in your cart</h6>
<h6 class="text-body">
    <a href="#" class="text-muted" id="clearCartBtn">
        <i class="fi-rs-trash mr-5"></i>Clear Cart
    </a>
</h6>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8">
                    <div id = "cart-container1" class="table-responsive shopping-summery">
                        <table class="table table-wishlist">
                            <thead>
                                <tr class="main-heading">
                                    <th class="custome-checkbox start pl-30">
                                        <input class="form-check-input" type="checkbox" name="checkbox" id="exampleCheckbox11" value="">
                                        <label class="form-check-label" for="exampleCheckbox11"></label>
                                    </th>
                                    <th scope="col">Product</th>
                                    <th scope="col">ProductName</th>
                                    <th scope="col">Unit Price</th>
                                    <th scope="col">Quantity</th>
                                    <th scope="col">Subtotal</th>
                                    <th scope="col" class="end">Remove</th>
                                </tr>
                            </thead>
                           <tbody>
    @foreach (var item in Model)
    {
        <tr class="@(item.quantity > item.Stock ? "outofstock" : "")">
            <td class="custome-checkbox pl-30">
                <input class="form-check-input" type="checkbox" name="checkbox[]" id="checkbox-@item.ProductTypeID" value="@item.ProductTypeID">
                <label class="form-check-label" for="checkbox-@item.ProductTypeID"></label>
            </td>
            <td class="image product-thumbnail">
                <a  asp-controller="Home" asp-action="ProductDetail" asp-route-id="@item.ProductID">
                <img src="@(item.img ?? "/images/default-product.png")" alt="@(item.ProductTyName ?? "S·∫£n ph·∫©m kh√¥ng t√™n")">
                </a>
            </td>
            <td class="product-des product-name">
            <h6 class="mb-5">
                <a class="product-name mb-10 text-heading" asp-controller="Home" asp-action="ProductDetail" asp-route-id="@item.ProductID">
                    @(item.ProductTyName ?? "S·∫£n ph·∫©m kh√¥ng t√™n")
                </a>
            </h6>
                       @*      <div class="product-rate-cover">
                    <div class="product-rate d-inline-block">
                        <div class="product-rating" style="width:@( (item.Rating / 5.0) * 100 )%"></div>
                    </div>
                    <span class="font-small ml-5 text-muted">@item.Rating</span>
                </div>
 *@
              @*   <!-- Th√™m ch·ªó ƒë·ªÉ hi·ªÉn th·ªã Product.ID n·∫øu c·∫ßn -->
                <span id="product-id-@item.ProductTypeID" class="product-id"></span> *@
            </td>
            <td class="price" data-title="Price">
                <h4 class="text-body" id="price-@item.ProductTypeID">@item.price</h4>
            </td>
            <td class="text-center detail-info" data-title="Stock">
                <div class="detail-extralink mr-15">
                    <div class="detail-qty border radius">
                        <a href="#" class="qty-down" data-id="@item.ProductTypeID">
                            <i class="fi-rs-angle-small-down"></i>
                        </a>
                        <input type="text" name="quantity" class="qty-val" value="@item.quantity"
                               data-id="@item.ProductTypeID" data-stock="@item.Stock" min="1">
                        <a href="#" class="qty-up" data-id="@item.ProductTypeID">
                            <i class="fi-rs-angle-small-up"></i>
                        </a>
                    </div>
                </div>
            </td>
            <td class="price" data-title="Subtotal">
                <h4 class="text-brand" id="subtotal-@item.ProductTypeID">@item.Subtotal</h4>
            </td>
           <td class="action text-center" data-title="Remove">
    <a type="button" class="text-body delete-cart" data-id="@item.CartID">
        <i class="fi-rs-trash"></i>
    </a>
</td>
        </tr>
    }
</tbody>


                        </table>
                    </div>
                    <div class="divider-2 mb-30"></div>
                    <!-- N√∫t ch·ªçn voucher -->
                    <div class="cart-action d-flex justify-content-between">
                        <a class="btn"><i class="fi-rs-arrow-left mr-10"></i>Continue Shopping</a>
                        <a class="btn mr-10 mb-sm-15" data-bs-toggle="modal" data-bs-target="#voucherShopeeModal">
                            <i class="fi-rs-refresh mr-10"></i>Update Cart
                        </a>
                    </div>

                    <!-- CSS -->
                    <style>
                        #voucherListContainer {
                            max-height: 50vh;
                            overflow-y: auto;
                        }
                    </style>

                    <!-- Modal -->
                    <div class="modal fade" id="voucherShopeeModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content rounded-3">

                                <!-- Header -->
                                <div class="modal-header">
                                    <h5 class="modal-title fw-bold">Ch·ªçn Shopee Voucher</h5>
                                    <a href="#" id="helpLink" class="text-muted small" data-bs-toggle="popover"
                                       data-bs-trigger="focus" data-bs-html="true" title="H·ªó Tr·ª£" data-bs-content='
                                        <strong>C√°ch S·ª≠ D·ª•ng Voucher</strong><br>
                                        ƒê·ªÉ √°p d·ª•ng m√£ Shopee voucher, b·∫°n h√£y ch·ªçn n√∫t "L∆∞u" ƒë·ªÉ l·∫•y voucher.<br><br>
                                        <strong>C√°ch T√¨m Voucher</strong><br>
                                        B·∫°n c√≥ th·ªÉ t√¨m th·∫•y Shopee Voucher xuy√™n su·ªët trang shopee.vn v√† ·ª©ng d·ª•ng.
                                        '>
                                        H·ªó Tr·ª£ <i class="bi bi-question-circle"></i>
                                    </a>



                                </div>

                                <!-- Body -->
                                <div class="modal-body pt-0">

                                    <!-- Search -->
                                    <div class="input-group my-3">
                                        <span class="input-group-text">M√£ Voucher</span>
                                        <input id="voucherSearchInput" type="text" class="form-control"
                                               placeholder="Nh·∫≠p m√£...">
                                       
                                        <button id="applyVoucherCode" class="btn btn-outline-primary">√ÅP D·ª§NG</button>
                                      
                                    </div>
                                    <span id="voucherSearchError" class="text-danger small ms-1"></span>

                                    <!-- Tab ch·ªçn lo·∫°i voucher -->
                                    <ul class="nav nav-pills mb-3" id="voucherTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" data-type="all" type="button">
                                                T·∫•t c·∫£
                                                Voucher
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" data-type="store" type="button">
                                                Voucher c·ªßa C·ª≠a
                                                H√†ng
                                            </button>
                                        </li>
                                    </ul>

                                    <!-- Scrollable Voucher List only -->
                                    <div id="voucherListContainer">
                                        <!-- AJAX s·∫Ω render ·ªü ƒë√¢y -->
                                    </div>

                                </div>

                                <!-- Footer -->
                                <div class="modal-footer justify-content-between">
                                    <div class="small" id="selectedVoucherInfo">
                                        Ch∆∞a ch·ªçn voucher n√†o
                                    </div>
                                    <div>
                                        <button class="btn btn-secondary" data-bs-dismiss="modal">TR·ªû L·∫†I</button>
                                        <button class="btn btn-danger" id="confirmVoucherBtn">OK</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const helpLink = document.getElementById('helpLink');
                            new bootstrap.Popover(helpLink);
                        });
                    </script>
                    <script>
                        let loadedVouchers = [];
                        let selectedVoucherCode = null;

                        function renderVoucherList(vouchers) {
                            const container = document.getElementById("voucherListContainer");
                            container.innerHTML = "";

                            vouchers.forEach(v => {
                                const disabledClass = v.disabled ? "bg-light text-muted" : "";
                                const disabledAttr = v.disabled ? "disabled" : "";
                                const conditionNote = v.disabled ? `<div class="text-danger small mt-1">Kh√¥ng th·ªÉ s·ª≠ d·ª•ng voucher n√†y.</div>` : "";
                                const textClass = v.disabled ? "text-muted" : "text-dark";
                                const mutedClass = v.disabled ? "text-muted" : "text-dark";
                                const maxDiscountNote = v.maxDiscountAmount ? `<div class="${mutedClass} small">Gi·∫£m t·ªëi ƒëa: ${v.maxDiscountAmount}</div>` : "";
                                const checkedAttr = v.code === selectedVoucherCode ? "checked" : "";

                                const item = document.createElement("div");
                                item.className = `voucher-item position-relative border rounded-3 d-flex p-3 mb-3 shadow-sm ${disabledClass}`;
                                item.innerHTML = `
                                        <div class="voucher-left text-center pe-3">
                                            <div class="${v.disabled ? 'bg-secondary' : 'bg-danger'} text-white p-3 rounded-start">
                                                <i class="bi bi-bag-fill fs-4 d-block"></i>
                                                <div class="small mt-1">SHOPEE</div>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold ${textClass}">${v.title} <span class="text-primary">(${v.code})</span></div>
                                            ${maxDiscountNote}
                                            <div class="${mutedClass} small">ƒê∆°n T·ªëi Thi·ªÉu ${v.minOrder}</div>
                                            <div class="${mutedClass} small mt-1">HSD: ${v.expire}
                                                <a href="#" class="ms-2 text-decoration-underline text-primary voucher-condition-link" data-code="${v.code}" data-bs-toggle="modal" data-bs-target="#voucherConditionModal">ƒêi·ªÅu Ki·ªán</a>
                                                ${conditionNote}
                                            </div>
                                        </div>
                                        <div class="position-absolute top-0 end-0 p-2">
                                            <span class="badge ${v.disabled ? 'bg-secondary' : 'bg-danger'} rounded-pill">x ${v.count}</span>
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="radio" name="voucherOption" value="${v.code}" ${disabledAttr} ${checkedAttr}>
                                            </div>
                                        </div>
                                    `;
                                container.appendChild(item);
                            });
                        }

                        function applySelectedVoucher() {
                            const selected = document.querySelector('input[name="voucherOption"]:checked');
                            if (selected && !selected.disabled) {
                                const code = selected.value;
                                selectedVoucherCode = code;
                                const infoBox = document.getElementById("selectedVoucherInfo");
                                if (infoBox) {
                                    infoBox.innerHTML = `1 Voucher ƒë√£ ƒë∆∞·ª£c ch·ªçn <span class="text-danger">${code}</span>`;
                                }

                                const rawSubtotal = document.getElementById("subtotal-amount")?.innerText || "‚Ç´0";
                                const currentSubtotal = parseInt(rawSubtotal.replace(/[^\d]/g, '')) || 0;

                                fetch("/voucher/calculate-discount", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ code: code, orderTotal: currentSubtotal })
                                })
                                    .then(res => {
                                        if (!res.ok) throw new Error("Voucher kh√¥ng √°p d·ª•ng.");
                                        return res.json();
                                    })
                                    .then(data => {
                                        const discount = Number(data.discountAmount);
                                        const subtotal = Number(data.orderTotalAfterDiscount) + discount;
                                        updateCartTotal(subtotal, discount, data.code, data.discountType);
                                    })
                                    .catch(err => {
                                        console.error("L·ªói khi g·ªçi API t√≠nh gi·∫£m gi√°:", err);
                                        alert("Kh√¥ng th·ªÉ √°p d·ª•ng voucher: " + err.message);
                                    });

                                const modal = bootstrap.Modal.getInstance(document.getElementById('voucherShopeeModal'));
                                if (modal) modal.hide();
                            } else {
                                alert("Vui l√≤ng ch·ªçn m·ªôt m√£ gi·∫£m gi√° h·ª£p l·ªá.");
                            }
                        }

                        function updateCartTotal(originalSubtotal, discount, code, discountType) {
                            if (typeof originalSubtotal !== "number" || typeof discount !== "number") {
                                console.error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·ª´ API:", { originalSubtotal, discount });
                                return;
                            }

                            const discountedTotal = originalSubtotal - discount;
                            const formattedDiscount = discountType === "Percent"
                                ? `-${discount}%`
                                : `-‚Ç´${discount.toLocaleString()}`;

                            document.getElementById("subtotal-amount").innerText = `‚Ç´${originalSubtotal.toLocaleString()}`;
                            document.getElementById("discount-amount").innerText = formattedDiscount;
                            document.getElementById("codevocher").innerText = `${code}`;
                            document.getElementById("cart-total").innerText = `‚Ç´${discountedTotal.toLocaleString()}`;
                            document.getElementById("discount-row").style.display = discount > 0 ? "" : "none";
                            document.getElementById("codevocher-row").style.display = discount > 0 ? "" : "none";
                        }

                        function handleConditionModal(code) {
                            const v = loadedVouchers.find(x => x.code === code);
                            const modalBody = document.querySelector("#voucherConditionModal .modal-body");
                            if (!v) {
                                modalBody.innerHTML = `<div class="text-danger">Kh√¥ng t√¨m th·∫•y th√¥ng tin voucher.</div>`;
                                return;
                            }
                            modalBody.innerHTML = `
                                    <p><strong>M√£:</strong> ${v.code}</p>
                                    <p><strong>ƒê∆°n t·ªëi thi·ªÉu:</strong> ${v.minOrder}</p>
                                    ${v.maxDiscountAmount ? `<p><strong>Gi·∫£m t·ªëi ƒëa:</strong> ${v.maxDiscountAmount}</p>` : ""}
                                    <p><strong>HSD:</strong> ${v.expire}</p>
                                    <p><strong>Lo·∫°i:</strong> ${v.isStoreVoucher ? "Voucher c·ª≠a h√†ng" : "Voucher to√†n s√†n (admin)"}</p>
                                `;
                        }

                        function attachVoucherEvents() {
                            document.querySelectorAll('#voucherTab .nav-link').forEach(btn => {
                                btn.addEventListener("click", function () {
                                    document.querySelectorAll('#voucherTab .nav-link').forEach(b => b.classList.remove('active'));
                                    this.classList.add('active');
                                    const type = this.getAttribute("data-type");
                                    const filtered = type === "store"
                                        ? loadedVouchers.filter(v => v.isStoreVoucher)
                                        : loadedVouchers;
                                    renderVoucherList(filtered);
                                });
                            });

                            document.addEventListener("click", function (e) {
                                const item = e.target.closest(".voucher-item");
                                if (item && !item.classList.contains("text-muted")) {
                                    const radio = item.querySelector('input[type="radio"]');
                                    if (radio && !radio.disabled) {
                                        radio.checked = true;
                                        selectedVoucherCode = radio.value;
                                        const infoBox = document.getElementById("selectedVoucherInfo");
                                        if (infoBox) {
                                            infoBox.innerHTML = `1 Voucher ƒë√£ ƒë∆∞·ª£c ch·ªçn <span class="text-danger">${selectedVoucherCode}</span>`;
                                        }
                                    }
                                }

                                const link = e.target.closest(".voucher-condition-link");
                                if (link) {
                                    const code = link.getAttribute("data-code");
                                    handleConditionModal(code);
                                }
                            });

                            document.getElementById("confirmVoucherBtn").addEventListener("click", applySelectedVoucher);

                            document.getElementById("applyVoucherCode").addEventListener("click", async function () {
                                const input = document.getElementById("voucherSearchInput").value.trim();
                                const errorBox = document.getElementById("voucherSearchError");
                                errorBox.innerText = "";

                                if (!input) {
                                    errorBox.innerText = "Vui l√≤ng nh·∫≠p m√£ voucher.";
                                    return;
                                }

                                try {
                                    const res = await fetch(`/voucher/search?code=${encodeURIComponent(input)}`);
                                    if (!res.ok) {
                                        const err = await res.json();
                                        errorBox.innerText = err.message || "Kh√¥ng t√¨m th·∫•y voucher.";
                                        return;
                                    }

                                    const foundVoucher = await res.json();
                                    renderVoucherList([foundVoucher]);
                                } catch (err) {
                                    console.error("L·ªói t√¨m ki·∫øm voucher:", err);
                                    errorBox.innerText = "ƒê√£ x·∫£y ra l·ªói khi t√¨m voucher.";
                                }
                            });
                        }

                        async function loadVouchers() {
                            try {
                                const res = await fetch("/voucher/get-all");
                                if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i voucher.");
                                loadedVouchers = await res.json();
                                renderVoucherList(loadedVouchers);
                            } catch (err) {
                                document.getElementById("voucherListContainer").innerHTML = `<div class="text-danger">L·ªói khi t·∫£i voucher.</div>`;
                            }
                        }

                        document.getElementById("voucherShopeeModal").addEventListener("show.bs.modal", async function () {
                            await loadVouchers();
                        });

                        document.addEventListener("DOMContentLoaded", function () {
                            const helpLink = document.getElementById('helpLink');
                            if (helpLink) new bootstrap.Popover(helpLink);
                            attachVoucherEvents();
                        });
                    </script>







                    <div class="modal fade" id="voucherConditionModal" tabindex="-1" aria-labelledby="voucherConditionModalLabel"
                         aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content rounded-3">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="voucherConditionModalLabel">ƒêi·ªÅu Ki·ªán Voucher</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>√Åp d·ª•ng cho ƒë∆°n t·ªëi thi·ªÉu:</strong> ‚Ç´200.000</p>
                                    <p><strong>Gi·∫£m t·ªëi ƒëa:</strong> ‚Ç´50.000</p>
                                    <p><strong>Ch·ªâ √°p d·ª•ng cho s·∫£n ph·∫©m thu·ªôc shop XYZ</strong></p>
                                    <p class="text-muted small">H·∫°n s·ª≠ d·ª•ng: 01/06/2025 - 15/06/2025</p>
                                </div>
                            </div>
                        </div>
                    </div>
                 
                </div>
                @{
    decimal total = 0; // üîπ Bi·∫øn l∆∞u t·ªïng gi√° tr·ªã
}
                <div class="col-lg-4">
                    <div class="border p-md-4 cart-totals ml-30">
                        <div class="table-responsive">
                            <table class="table no-border">
                              @foreach (var item in Model)
                {
                    total += item.Subtotal; // üî• C·ªông d·ªìn Subtotal c·ªßa t·ª´ng s·∫£n ph·∫©m
                }
                                
                                     <tbody>

                                        <tr>
                                            <td class="cart_total_label">
                                                <h6 class="text-muted">T·∫°m t√≠nh</h6>
                                            </td>
                                            <td class="cart_total_amount">
                                                <h5 class="text-end" id="subtotal-amount">@total.ToString("‚Ç´#,##0")</h5>
                                            </td>
                                        </tr>

                                        <tr id="codevocher-row" style="display: none;">
                                            <td class="cart_total_label">
                                                <h6 class="text-muted">Gi·∫£m gi√° voucher</h6>
                                            </td>
                                            <td class="cart_total_amount">
                                                <h5 class="text-danger text-end" id="codevocher">-‚Ç´0</h5>
                                            </td>
                                        </tr>  
                                        <tr id="discount-row" style="display: none;">
                                            <td class="cart_total_label">
                                                <h6 class="text-muted">S·ªë Ti·ªÅn Giam</h6>
                                            </td>
                                            <td class="cart_total_amount">
                                                <h5 class="text-danger text-end" id="discount-amount">-‚Ç´0</h5>
                                            </td>
                                        </tr>

                                        <tr>
                                            <td class="cart_total_label">
                                                <h6 class="text-muted">T·ªïng c·ªông</h6>
                                            </td>
                                            <td class="cart_total_amount">
                                                <h4 class="text-brand text-end" id="cart-total">@total.ToString("‚Ç´#,##0")</h4>
                                            </td>
                                        </tr>

                                 @*    <tr>
                                        <td scope="col" colspan="2">
                                            <div class="divider-2 mt-10 mb-10"></div>
                                        </td>
                                    </tr> *@
                                 @*    <tr>
                                        <td class="cart_total_label">
                                            <h6 class="text-muted">Shipping</h6>
                                        </td>
                                        <td class="cart_total_amount">
                                            <h5 class="text-heading text-end">Free</h5
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="cart_total_label">
                                            <h6 class="text-muted">Estimate for</h6>
                                        </td>
                                        <td class="cart_total_amount">
                                            <h5 class="text-heading text-end">United Kingdom</h5
                                        </td>
                                    </tr> *@
                                  @*   <tr>
                                        <td scope="col" colspan="2">
                                            <div class="divider-2 mt-10 mb-10"></div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="cart_total_label">
                                            <h6 class="text-muted">Total</h6>
                                        </td>
                                        <td class="cart_total_amount">
                                            <h4 class="text-brand text-end">@total</h4>
                                        </td>
                                    </tr> *@
                                </tbody>
                            
                               
                            </table>
                        </div>
                        @Html.AntiForgeryToken()
                        <button id="btn-submit" class="btn mb-20 w-100">Proceed To CheckOut<i class="fi-rs-sign-out ml-15"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="main">
        <section class="newsletter mb-15">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="position-relative newsletter-inner">
                            <div class="newsletter-content">
                                <h2 class="mb-20">Stay home & get your daily <br> needs from our shop</h2>
                                <p class="mb-45">Start You'r Daily Shopping with <span class="text-brand">Nest Mart</span></p>
                                <form class="form-subcriber d-flex">
                                    <input type="email" placeholder="Your emaill address">
                                    <button class="btn" type="submit">Subscribe</button>
                                </form>
                            </div>
                            <img src="~/assets/imgs/banner/banner-9.png" alt="newsletter">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="featured section-padding">
            <div class="container">
                <div class="row">
                    <div class="col-lg-1-5 col-md-4 col-12 col-sm-6 mb-md-4 mb-xl-0">
                        <div class="banner-left-icon d-flex align-items-center wow fadeIn  animated">
                            <div class="banner-icon">
                                <img src="~/assets/imgs/theme/icons/icon-1.svg" alt="">
                            </div>
                            <div class="banner-text">
                                <h3 class="icon-box-title">Best prices & offers</h3>
                                <p>Orders $50 or more</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-1-5 col-md-4 col-12 col-sm-6">
                        <div class="banner-left-icon d-flex align-items-center wow fadeIn  animated">
                            <div class="banner-icon">
                                <img src="~/assets/imgs/theme/icons/icon-2.svg" alt="">
                            </div>
                            <div class="banner-text">
                                <h3 class="icon-box-title">Free delivery</h3>
                                <p>24/7 amazing services</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-1-5 col-md-4 col-12 col-sm-6">
                        <div class="banner-left-icon d-flex align-items-center wow fadeIn  animated">
                            <div class="banner-icon">
                                <img src="~/assets/imgs/theme/icons/icon-3.svg" alt="">
                            </div>
                            <div class="banner-text">
                                <h3 class="icon-box-title">Great daily deal</h3>
                                <p>When you sign up</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-1-5 col-md-4 col-12 col-sm-6">
                        <div class="banner-left-icon d-flex align-items-center wow fadeIn  animated">
                            <div class="banner-icon">
                                <img src="~/assets/imgs/theme/icons/icon-4.svg" alt="">
                            </div>
                            <div class="banner-text">
                                <h3 class="icon-box-title">Wide assortment</h3>
                                <p>Mega Discounts</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-1-5 col-md-4 col-12 col-sm-6">
                        <div class="banner-left-icon d-flex align-items-center wow fadeIn  animated">
                            <div class="banner-icon">
                                <img src="~/assets/imgs/theme/icons/icon-5.svg" alt="">
                            </div>
                            <div class="banner-text">
                                <h3 class="icon-box-title">Easy returns</h3>
                                <p>Within 30 days</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-1-5 col-md-4 col-12 col-sm-6 d-xl-none">
                        <div class="banner-left-icon d-flex align-items-center wow fadeIn  animated">
                            <div class="banner-icon">
                                <img src="~/assets/imgs/theme/icons/icon-6.svg" alt="">
                            </div>
                            <div class="banner-text">
                                <h3 class="icon-box-title">Safe delivery</h3>
                                <p>Within 30 days</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="section-padding footer-mid">
            <div class="container pt-15 pb-20">
                <div class="row">
                    <div class="col">
                        <div class="widget-about font-md mb-md-3 mb-lg-3 mb-xl-0">
                            <div class="logo mb-30">
                                <a href="index.html" class="mb-15"><img src="~/assets/imgs/theme/logo.svg" alt="logo"></a>
                                <p class="font-lg text-heading">Awesome grocery store website template</p>
                            </div>
                            <ul class="contact-infor">
                                <li><img src="~/assets/imgs/theme/icons/icon-location.svg" alt=""><strong>Address: </strong> <span>5171 W Campbell Ave undefined Kent, Utah 53127 United States</span></li>
                                <li><img src="~/assets/imgs/theme/icons/icon-contact.svg" alt=""><strong>Call Us:</strong><span>(+91) - 540-025-124553</span></li>
                                <li><img src="~/assets/imgs/theme/icons/icon-email-2.svg" alt=""><strong>Email:</strong><span>sale@Nest.com</span></li>
                                <li><img src="~/assets/imgs/theme/icons/icon-clock.svg" alt=""><strong>Hours:</strong><span>10:00 - 18:00, Mon - Sat</span></li>
                            </ul>
                        </div>
                    </div>
                    <div class="footer-link-widget col">
                        <h4 class="widget-title">Company</h4>
                        <ul class="footer-list mb-sm-5 mb-md-0">
                            <li><a href="#">About Us</a></li>
                            <li><a href="#">Delivery Information</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                            <li><a href="#">Terms &amp; Conditions</a></li>
                            <li><a href="#">Contact Us</a></li>
                            <li><a href="#">Support Center</a></li>
                            <li><a href="#">Careers</a></li>
                        </ul>
                    </div>
                    <div class="footer-link-widget col">
                        <h4 class="widget-title">Account</h4>
                        <ul class="footer-list mb-sm-5 mb-md-0">
                            <li><a href="#">Sign In</a></li>
                            <li><a href="#">View Cart</a></li>
                            <li><a href="#">My Wishlist</a></li>
                            <li><a href="#">Track My Order</a></li>
                            <li><a href="#">Help Ticket</a></li>
                            <li><a href="#">Shipping Details</a></li>
                            <li><a href="#">Compare products</a></li>
                        </ul>
                    </div>
                    <div class="footer-link-widget col">
                        <h4 class="widget-title">Corporate</h4>
                        <ul class="footer-list mb-sm-5 mb-md-0">
                            <li><a href="#">Become a Vendor</a></li>
                            <li><a href="#">Affiliate Program</a></li>
                            <li><a href="#">Farm Business</a></li>
                            <li><a href="#">Farm Careers</a></li>
                            <li><a href="#">Our Suppliers</a></li>
                            <li><a href="#">Accessibility</a></li>
                            <li><a href="#">Promotions</a></li>
                        </ul>
                    </div>
                    <div class="footer-link-widget col">
                        <h4 class="widget-title">Popular</h4>
                        <ul class="footer-list mb-sm-5 mb-md-0">
                            <li><a href="#">Milk & Flavoured Milk</a></li>
                            <li><a href="#">Butter and Margarine</a></li>
                            <li><a href="#">Eggs Substitutes</a></li>
                            <li><a href="#">Marmalades</a></li>
                            <li><a href="#">Sour Cream and Dips</a></li>
                            <li><a href="#">Tea & Kombucha</a></li>
                            <li><a href="#">Cheese</a></li>
                        </ul>
                    </div>
                    <div class="footer-link-widget widget-install-app col">
                        <h4 class="widget-title">Install App</h4>
                        <p class="wow fadeIn animated">From App Store or Google Play</p>
                        <div class="download-app">
                            <a href="#" class="hover-up mb-sm-2 mb-lg-0"><img class="active" src="~/assets/imgs/theme/app-store.jpg" alt=""></a>
                            <a href="#" class="hover-up mb-sm-2"><img src="~/assets/imgs/theme/google-play.jpg" alt=""></a>
                        </div>
                        <p class="mb-20">Secured Payment Gateways</p>
                        <img class="wow fadeIn animated" src="~/assets/imgs/theme/payment-method.png" alt="">
                    </div>
                </div>
            </div>
        </section>
        <div class="container pb-30">
            <div class="row align-items-center">
                <div class="col-12 mb-30">
                    <div class="footer-bottom"></div>
                </div>
                <div class="col-xl-4 col-lg-6 col-md-6">
                    <p class="font-sm mb-0">
                        &copy; 2024, <strong class="text-brand">Nest</strong> - HTML Ecommerce Template
                        <br>All rights reserved
                    </p>
                </div>
                <div class="col-xl-4  col-lg-6 text-center d-none d-xl-block">
                    <div class="hotline d-lg-inline-flex mr-30">
                        <img src="~/assets/imgs/theme/icons/phone-call.svg" alt="hotline">
                        <p>1900 - 6666<span>Working 8:00 - 22:00</span></p>
                    </div>
                    <div class="hotline d-lg-inline-flex">
                        <img src="~/assets/imgs/theme/icons/phone-call.svg" alt="hotline">
                        <p>1900 - 8888<span>24/7 Support Center</span></p>
                    </div>
                </div>
                <div class="col-xl-4  col-lg-6  col-md-6 text-end d-none d-md-block">
                    <div class="mobile-social-icon">
                        <h6>Follow Us </h6>
                        <a href="#"><img src="~/assets/imgs/theme/icons/icon-facebook-white.svg" alt=""></a>
                        <a href="#"><img src="~/assets/imgs/theme/icons/icon-twitter-white.svg" alt=""></a>
                        <a href="#"><img src="~/assets/imgs/theme/icons/icon-instagram-white.svg" alt=""></a>
                        <a href="#"><img src="~/assets/imgs/theme/icons/icon-pinterest-white.svg" alt=""></a>
                        <a href="#"><img src="~/assets/imgs/theme/icons/icon-youtube-white.svg" alt=""></a>
                    </div>
                    <p class="font-sm">Up to 15% discount on your first subscribe</p>
                </div>
            </div>
        </div>
    </footer>
    <!-- Preloader Start -->
    <div id="preloader-active">
        <div class="preloader d-flex align-items-center justify-content-center">
            <div class="preloader-inner position-relative">
                <div class="text-center">
                    <img src="~/assets/imgs/theme/loading.gif" alt="">
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script>
$(document).ready(function () {
    var pendingRequests = {};
    var isProcessing = false;
    var throttleTimeout = 800;

    console.log("Script initialized at: ", new Date());

    function checkStock() {
        $("input.qty-val").each(function () {
            var inputField = $(this);
            var productTypeId = inputField.data("id");
            if (!productTypeId) {
                console.error("ProductTypeID is not defined for input:", inputField);
                return;
            }
            var stockQty = parseInt(inputField.attr("data-stock")) || 0;
            var currentQty = parseInt(inputField.val()) || 0;
            var row = inputField.closest("tr");

            console.log("Checking product:", productTypeId);
            console.log("Stock quantity:", stockQty, "üõí Cart quantity:", currentQty);

                 if (currentQty > stockQty) {
               row.addClass("outofstock");
                  if (!row.find(".out-of-stock-label").length) {
                            row.find(".product-des").append('<span class="out-of-stock-label">Quantity exceeds available stock, please reduce it!</span>');
                        }
                        row.find(".qty-up").prop("disabled", true);
                        row.find(".qty-down").prop("disabled", false);
            } else {
                row.removeClass("outofstock");
                row.find(".out-of-stock-label").remove();
                row.find(".qty-up").prop("disabled", false);
                row.find(".qty-down").prop("disabled", currentQty <= 1);
            }

            if (currentQty >= stockQty) {
                $(".qty-up[data-id='" + productTypeId + "']").hide();
            } else {
                $(".qty-up[data-id='" + productTypeId + "']").show();
            }
            if (currentQty <= 1) {
                $(".qty-down[data-id='" + productTypeId + "']").hide();
            } else {
                $(".qty-down[data-id='" + productTypeId + "']").show();
            }
        });
    }   

    checkStock();

    function throttle(func, wait) {
        var timeout = null;
        var previous = 0;
        return function () {
            var now = Date.now();
            var remaining = wait - (now - previous);
            var context = this, args = arguments;
            if (remaining <= 0) {
                if (timeout) {
                    clearTimeout(timeout);
                    timeout = null;
                }
                previous = now;
                func.apply(context, args);
            } else if (!timeout) {
                timeout = setTimeout(function () {
                    previous = Date.now();
                    timeout = null;
                    func.apply(context, args);
                }, remaining);
            }
        };
    }

    $(".qty-up, .qty-down").off("click").off("dblclick").on("click", throttle(function (e) {
        e.preventDefault();

        console.log("Click triggered for ProductTypeID:", $(this).data("id"), "at", new Date());

        if (isProcessing) {
            console.log("Global request is being processed...");
            return;
        }

        var button = $(this);
        var productTypeId = button.data("id");
        if (!productTypeId) {
            console.error("ProductTypeID is not defined for button:", button);
            alert("Error: ProductTypeID not found!");
            return;
        }
        productTypeId = productTypeId.toString();

        if (pendingRequests[productTypeId]) {
            console.log("Request already in progress for ProductTypeID:", productTypeId);
            return;
        }

        var inputField = $("input[data-id='" + productTypeId + "']");
        if (inputField.length === 0) {
            console.error("Cannot find input with ProductTypeID:", productTypeId);
            alert("Error: Quantity input not found!");
            return;
        }

        var currentQty = parseInt(inputField.val()) || 0;
        console.log("Before update - ProductTypeID:", productTypeId, "CurrentQty:", currentQty, "Time:", new Date());

        var stockQty = parseInt(inputField.attr("data-stock")) || 0;
        var isIncrease = button.hasClass("qty-up");
        var newQty = isIncrease ? currentQty + 1 : currentQty - 1;

        console.log("Calculated newQty:", newQty, "StockQty:", stockQty);

        if (isIncrease && newQty > stockQty) {
            alert("The order quantity has reached the stock limit (" + stockQty + ").");
            inputField.val(stockQty);
            $(".qty-up[data-id='" + productTypeId + "']").hide();
            checkStock();
            return;
        }

        if (!isIncrease && newQty < 1) {
            alert("Minimum quantity is 1.");
            return;
        }

        var buttons = $(".qty-up[data-id='" + productTypeId + "'], .qty-down[data-id='" + productTypeId + "']");
        buttons.prop("disabled", true);
        button.html('<i class="fas fa-spinner fa-spin"></i>');

        pendingRequests[productTypeId] = true;
        isProcessing = true;

        $.ajax({
            url: "/Home/CheckQuantity",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                ProductTypeID: productTypeId,
                quantity: newQty
            }),
            success: function (response) {
                console.log("‚úÖ Server response:", response, "Time:", new Date());
                if (response.success) {
                    var serverQty = response.quantity !== undefined ? response.quantity : newQty;
                    inputField.val(serverQty);
                    console.log("Quantity updated successfully:", serverQty);

                    if (response.isMaxStock) {
                        alert("‚ö†Ô∏è " + response.message);
                    }
                    if (response.productId) {
                        console.log(" Product ID:", response.productId);
                        $("#product-id-" + productTypeId).text(response.productId);
                    }

                    if (serverQty >= stockQty) {
                        $(".qty-up[data-id='" + productTypeId + "']").hide();
                    } else {
                        $(".qty-up[data-id='" + productTypeId + "']").show();
                    }
                    if (serverQty <= 1) {
                        $(".qty-down[data-id='" + productTypeId + "']").hide();
                    } else {
                        $(".qty-down[data-id='" + productTypeId + "']").show();
                    }

                    var unitPrice = parseFloat($("#price-" + productTypeId).text()) || 0;
                    var newSubtotal = serverQty * unitPrice;
                    $("#subtotal-" + productTypeId).text(newSubtotal.toFixed(2));
                    updateTotalPrice();
                    checkStock();
                } else {
                    alert("‚ö†Ô∏è Update failed: " + response.message);
                    inputField.val(currentQty);
                    console.log(" Quantity reverted to:", currentQty);
                    checkStock();
                }
            },
            error: function (xhr) {
                console.error("‚ùå AJAX error:", xhr, "Time:", new Date());
                alert("‚ö†Ô∏è Server error, please try again!");
                inputField.val(currentQty);
                console.log(" Quantity reverted due to error:", currentQty);
                checkStock();
            },
            complete: function () {
                delete pendingRequests[productTypeId];
                isProcessing = false;
                buttons.prop("disabled", false);
                button.html(isIncrease ? '<i class="fi-rs-angle-small-up"></i>' : '<i class="fi-rs-angle-small-down"></i>');
            }
        });
    }, throttleTimeout)).on("dblclick", function (e) {
        e.preventDefault();
        console.log(" Double-click detected and prevented for ProductTypeID:", $(this).data("id"));
    });

    function updateTotalPrice() {
        var total = 0;
        var hasCheckedItems = $("input.form-check-input:checked").length > 0;
        if (hasCheckedItems) {
            $("input.form-check-input:checked").each(function () {
                var row = $(this).closest("tr");
                if (!row.hasClass("outofstock")) {
                    var subtotal = parseFloat(row.find("td.price h4.text-brand").text().replace(/,/g, '')) || 0;
                    total += subtotal;
                }
            });
        } else {
            $("tr").not(".outofstock").each(function () {
                var subtotal = parseFloat($(this).find("td.price h4.text-brand").text().replace(/,/g, '')) || 0;
                total += subtotal;
            });
        }
        $("#cart-total").text(total.toFixed(2));
        console.log(" Cart total updated:", total.toFixed(2));
    }
});
</script>








   <script>
    $(document).ready(function () {
    $(".delete-cart").click(function (e) {
        e.preventDefault(); // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh (d√π ƒë√£ d√πng button)

        var cartId = $(this).data("id");
        if (!cartId) {
            Swal.fire({
                title: "Error!",
                text: "Cart ID not found.",
                icon: "error"
            });
            return;
        }

        Swal.fire({
            title: "Are you sure you want to delete?",
            text: "This product will be removed from your cart!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Delete",
            cancelButtonText: "Cancel"
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "/Home/DeleteCart",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ CartID: cartId }),
                    success: function (response) {
                        if (response.success === true) {
                            Swal.fire({
                                title: "Deleted!",
                                text: "The product has been removed from your cart.",
                                icon: "success",
                                timer: 2000,
                                showConfirmButton: false
                            });

                            // T√¨m h√†ng d·ª±a tr√™n CartID
                            var row = $(".delete-cart[data-id='" + cartId + "']").closest("tr");
                            var removedSubtotal = parseFloat(row.find("td.price h4.text-brand").text().replace(/,/g, '')) || 0;
                            row.remove();

                            var currentTotal = parseFloat($("#cart-total").text().replace(/,/g, '')) || 0;
                            var newTotal = currentTotal - removedSubtotal;
                            $("#cart-total").text(newTotal.toFixed(2));
                        } else {
                            Swal.fire({
                                title: "Error!",
                                text: response.message || "Failed to delete the product.",
                                icon: "error"
                            });
                        }
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            Swal.fire({
                                title: "Unauthorized!",
                                text: "Please log in to perform this action.",
                                icon: "warning"
                            }).then(() => {
                                window.location.href = "/Home/Login"; // Chuy·ªÉn h∆∞·ªõng th·ªß c√¥ng
                            });
                        } else {
                            Swal.fire({
                                title: "Error!",
                                text: "Something went wrong. Please try again.",
                                icon: "error"
                            });
                        }
                    }
                });
            }
        });
    });
});
</script>

    <script>
        $(document).ready(function () {
            function getTotalPrice() {
                var total = 0;
                $("tr").not(".outofstock").find("td.price h4.text-brand").each(function () {
                    var subtotal = parseFloat($(this).text().replace(/,/g, '')) || 0;
                    total += subtotal;
                });
                return total.toFixed(2);
            }

            function updateSelectedTotal() {
                var total = 0;
                var checkedItems = $("input.form-check-input:checked");

                console.log("üü¢ S·ªë l∆∞·ª£ng checkbox ƒë∆∞·ª£c ch·ªçn:", checkedItems.length);

                if (checkedItems.length > 0) {
                    checkedItems.each(function () {
                        var row = $(this).closest("tr");
                        if (!row.hasClass("outofstock")) { // Ch·ªâ t√≠nh t·ªïng s·∫£n ph·∫©m kh√¥ng b·ªã m·ªù
                            var subtotalText = row.find("td.price h4.text-brand").text().replace(/,/g, '');
                            var subtotal = parseFloat(subtotalText) || 0;
                            total += subtotal;
                        }
                    });
                    console.log("‚ö° T·ªïng ti·ªÅn c·ªßa c√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn:", total);

                    // G√°n v√†o subtotal
                    document.getElementById("subtotal-amount").innerText = `‚Ç´${total.toLocaleString()}`;

                    // G√°n v√†o cart total (gi·∫£ s·ª≠ ch∆∞a tr·ª´ voucher)
                    document.getElementById("cart-total").innerText = `‚Ç´${total.toLocaleString()}`;


                } else {
                    total = parseFloat(getTotalPrice());
                    console.log("‚ö° Kh√¥ng c√≥ checkbox n√†o ƒë∆∞·ª£c ch·ªçn. T·ªïng ti·ªÅn = 0");
                }

                $("#cart-total").text(total.toFixed(2));
            }

            $("input.form-check-input").change(function () {
                updateSelectedTotal();
            });

            $("#exampleCheckbox11").change(function () {
                var isChecked = $(this).prop("checked");
                $("input.form-check-input").prop("checked", isChecked).trigger("change");
            });

            // ƒê·∫£m b·∫£o t·ªïng gi√° tr·ªã ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng khi t·∫£i trang
            $("input.form-check-input").prop("checked", false);
            updateSelectedTotal();
        });



        $("#btn-submit").click(function () {
            var token = $("input[name='__RequestVerificationToken']").val();
            var selectedProducts = [];

            $("input.form-check-input:checked").each(function () {
                selectedProducts.push($(this).val());
            });

            if (selectedProducts.length === 0) {
                new Notify({
                    status: 'error',
                    title: 'Th·∫•t B·∫°i',
                    text: 'Vui l√≤ng ch·ªçn it nh·∫•t 1 s·∫£n ph·∫©m.',
                    effect: 'fade',
                    speed: 300,
                    showIcon: true,
                    showCloseButton: true,
                    autoclose: true,
                    autotimeout: 3000,
                    position: 'right top'
                });
                return;
            }
            function isValidGuid(str) {
                return /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(str);
            }

            const formData = new FormData();
            formData.append("__RequestVerificationToken", token);
            selectedProducts.forEach(id => {
                if (isValidGuid(id)) {
                    formData.append("productIds[]", id);
                }
            });
            if (selectedVoucherCode) {
                formData.append("voucherCode", selectedVoucherCode);
            }

            $.ajax({
                url: "/Users/Buy",
                type: "POST",
                data: formData,
                processData: false, // NgƒÉn jQuery x·ª≠ l√Ω d·ªØ li·ªáu
                contentType: false, // ƒê·ªÉ tr√¨nh duy·ªát t·ª± ƒë·ªông thi·∫øt l·∫≠p content-type
                success: function (response) {

                    if (response.success) {
                        Swal.fire({
                            title: 'Th√†nh c√¥ng!',
                            text: 'B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang thanh to√°n...',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed || result.isDismissed) {
                                window.location.href = response.redirectUrl;
                            }
                        });
                    } else {
                        new Notify({
                            status: 'error',
                            title: 'Th·∫•t B·∫°i',
                            text: response.msg || 'G·ª≠i th·∫•t b·∫°i!',
                            effect: 'fade',
                            speed: 300,
                            showIcon: true,
                            showCloseButton: true,
                            autoclose: true,
                            autotimeout: 3000,
                            position: 'right top'
                        });
                    }


                },
                error: function () {
                    new Notify({
                        status: 'error',
                        title: 'Th·∫•t B·∫°i',
                        text:  'ƒê√£ x·∫£y ra l·ªói vui l√≤ng th·ª≠ l·∫°i!',
                        effect: 'fade',
                        speed: 300,
                        showIcon: true,
                        showCloseButton: true,
                        autoclose: true,
                        autotimeout: 3000,
                        position: 'right top'
                    });
                }
            });
        });




    </script>
   <<script>
    $(document).ready(function () {
        $("#clearCartBtn").click(function (e) {
            e.preventDefault();

            Swal.fire({
                title: 'Are you sure?',
                text: "Do you want to clear the entire cart?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, clear it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: "POST",
                        url: "/Home/DeleteAllCart",
                        contentType: "application/json; charset=utf-8",
                        success: function (response) {
                            Swal.fire({
                                title: response.success ? 'Success' : 'Oops!',
                                text: response.message,
                                icon: response.success ? 'success' : 'error',
                                confirmButtonText: 'OK',
                                timer: 2000,
                                timerProgressBar: true,
                                position: 'center',
                                showConfirmButton: false
                            });

                            if (response.success) {
                                setTimeout(() => location.reload(), 2000);
                            }
                        },
                        error: function () {
                            Swal.fire({
                                title: 'Error',
                                text: 'An error occurred while clearing the cart.',
                                icon: 'error',
                                confirmButtonText: 'OK'
                            });
                        }
                    });
                }
            });
        });
    });
</script>


   @*  <script>
        $(document).ready(function () {
            function checkStock() {
                $("input.qty-val").each(function () {
                    var inputField = $(this);
                    var productId = inputField.data("id");
                    var stockQty = parseInt(inputField.attr("data-stock")) || 0;
                    var currentQty = parseInt(inputField.val()) || 0;
                    var row = inputField.closest("tr");

                    console.log("üîç Ki·ªÉm tra s·∫£n ph·∫©m:", productId);
                    console.log("üì¶ Kho th·ª±c t·∫ø:", stockQty, "üõí Gi·ªè h√†ng:", currentQty);

                    // Ki·ªÉm tra n·∫øu s·ªë l∆∞·ª£ng trong gi·ªè h√†ng v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng kho
                    if (currentQty > stockQty) {
                        row.addClass("outofstock"); // L√†m m·ªù v√† v√¥ hi·ªáu h√≥a
                        if (!row.find(".out-of-stock-label").length) {
                            row.find(".product-des").append('<span class="out-of-stock-label">‚ö†Ô∏è S·ªë l∆∞·ª£ng trong kho ƒë√£ thay ƒë·ªïi!</span>');
                        }
                        // V√¥ hi·ªáu h√≥a n√∫t tƒÉng
                        row.find(".qty-up").prop("disabled", true);
                        // Cho ph√©p gi·∫£m s·ªë l∆∞·ª£ng
                        row.find(".qty-down").prop("disabled", false);
                    } else {
                        row.removeClass("outofstock"); // Kh√¥ng l√†m m·ªù n·∫øu s·ªë l∆∞·ª£ng h·ª£p l·ªá
                        row.find(".out-of-stock-label").remove(); // X√≥a th√¥ng b√°o
                        // B·∫≠t l·∫°i n√∫t tƒÉng khi s·ªë l∆∞·ª£ng h·ª£p l·ªá
                        row.find(".qty-up").prop("disabled", false);
                        // V√¥ hi·ªáu h√≥a n√∫t gi·∫£m khi s·ªë l∆∞·ª£ng b·∫±ng 1
                        row.find(".qty-down").prop("disabled", currentQty <= 1);
                    }
                });
            }

            // G·ªçi khi trang load
            checkStock();

            // G·ªçi khi s·ªë l∆∞·ª£ng thay ƒë·ªïi
            $(".qty-up, .qty-down").click(function () {
                var inputField = $(this).closest("tr").find(".qty-val");
                var currentQty = parseInt(inputField.val()) || 0;
                var stockQty = parseInt(inputField.attr("data-stock")) || 0;

                // Ki·ªÉm tra ƒë·ªÉ kh√¥ng v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng trong kho
                if ($(this).hasClass("qty-up")) {
                    if (currentQty < stockQty) {
                        inputField.val(currentQty + 1);  // TƒÉng s·ªë l∆∞·ª£ng
                    }
                } else if ($(this).hasClass("qty-down")) {
                    if (currentQty > 1) {
                        inputField.val(currentQty - 1);  // Gi·∫£m s·ªë l∆∞·ª£ng
                    }
                }

                setTimeout(checkStock, 500); // Ki·ªÉm tra l·∫°i sau khi thay ƒë·ªïi
            });
        });


    </> *@



    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <!-- Vendor JS-->
    <script src="~/assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="~/assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="~/assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="~/assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="~/assets/js/plugins/slick.js"></script>
    <script src="~/assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="~/assets/js/plugins/wow.js"></script>
    <script src="~/assets/js/plugins/jquery-ui.js"></script>
    <script src="~/assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="~/assets/js/plugins/magnific-popup.js"></script>
    <script src="~/assets/js/plugins/select2.min.js"></script>
    <script src="~/assets/js/plugins/waypoints.js"></script>
    <script src="~/assets/js/plugins/counterup.js"></script>
    <script src="~/assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="~/assets/js/plugins/images-loaded.js"></script>
    <script src="~/assets/js/plugins/isotope.js"></script>
    <script src="~/assets/js/plugins/scrollup.js"></script>
    <script src="~/assets/js/plugins/jquery.vticker-min.js"></script>
    <script src="~/assets/js/plugins/jquery.theia.sticky.js"></script>
    <script src="~/assets/js/plugins/jquery.elevatezoom.js"></script>
    <!-- Template  JS -->
    <script src="~/assets/js/main.js?v=6.0"></script>
    <script src="~/assets/js/shop.js?v=6.0"></script>
</body>

</html>