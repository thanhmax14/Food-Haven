<!doctype html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg"
    data-sidebar-image="none" data-preloader="disable" data-theme="default" data-theme-colors="default">


<!-- Mirrored from themesbrand.com/velzon/html/master/tables-listjs.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 26 Feb 2025 12:22:15 GMT -->

<head>

    <meta charset="utf-8" />
    <title>Orders | Velzon - Admin & Dashboard Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
    <meta content="EasyFood" name="author" />
    <!-- App favicon -->
    <link rel="shortcut icon" href="~/assetsAdmin/images/favicon.svg">

    <!-- Sweet Alert css-->
    <link href="~/assetsAdmin/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css" />

    <!-- Layout config Js -->
    <script src="~/assetsAdmin/js/layout.js"></script>
    <!-- Bootstrap Css -->
    <link href="~/assetsAdmin/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="~/assetsAdmin/css/icons.min.css" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="~/assetsAdmin/css/app.min.css" rel="stylesheet" type="text/css" />
    <!-- custom Css-->
    <link href="~/assetsAdmin/css/custom.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="/~/assetsAdmin/libs/gridjs/gridjs.umd.js">
    <link rel="stylesheet" href="/~/assetsAdmin/libs/gridjs/theme/mermaid.min.css">
    <!-- Grid.js CSS -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <!-- Bootstrap CSS -->
    <!-- Remix Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- Lord Icon -->
    <script src="https://cdn.lordicon.com/libs/mssddfmo/lord-icon-2.1.0.js"></script>

</head>


<body>

    <!-- Begin page -->
    <div id="layout-wrapper">

        @await Html.PartialAsync("_headeradmin")

        <!-- removeNotificationModal -->
        <div id="removeNotificationModal" class="modal fade zoomIn" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                            id="NotificationModalbtn-close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mt-2 text-center">
                            <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop"
                                colors="primary:#f7b84b,secondary:#f06548" style="width:100px;height:100px"></lord-icon>
                            <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                                <h4>Are you sure ?</h4>
                                <p class="text-muted mx-4 mb-0">Are you sure you want to remove this Notification ?</p>
                            </div>
                        </div>
                        <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                            <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn w-sm btn-danger" id="delete-notification">
                                Yes, Delete
                                It!
                            </button>
                        </div>
                    </div>

                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <!-- ========== App Menu ========== -->
        <div class="app-menu navbar-menu">
            <!-- LOGO -->
            <div class="navbar-brand-box">
                <!-- Dark Logo-->
                <a class="logo logo-dark">
                    <span class="logo-sm">
                        <img src="~/assetsAdmin/images/logo-sm.svg" alt="" height="22">
                    </span>
                    <span class="logo-lg">
                        <img src="~/assetsAdmin/images/logo-dark.svg" alt="" height="35">
                    </span>
                </a>
                <!-- Light Logo-->
                <a class="logo logo-light">
                    <span class="logo-sm">
                        <img src="~/assetsAdmin/images/logo-sm.svg" alt="" height="22">
                    </span>
                    <span class="logo-lg">
                        <img src="~/assetsAdmin/images/logo-light.svg" alt="" height="35">
                    </span>
                </a>
                <button type="button" class="btn btn-sm p-0 fs-20 header-item float-end btn-vertical-sm-hover"
                    id="vertical-hover">
                    <i class="ri-record-circle-line"></i>
                </button>
            </div>

            <div class="dropdown sidebar-user m-1 rounded">
                <button type="button" class="btn material-shadow-none" id="page-header-user-dropdown"
                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="d-flex align-items-center gap-2">
                        <img class="rounded header-profile-user" src="assets/images/users/avatar-1.jpg"
                            alt="Header Avatar">
                        <span class="text-start">
                            <span class="d-block fw-medium sidebar-user-name-text">Anna Adame</span>
                            <span class="d-block fs-14 sidebar-user-name-sub-text">
                                <i class="ri ri-circle-fill fs-10 text-success align-baseline"></i> <span
                                    class="align-middle">Online</span>
                            </span>
                        </span>
                    </span>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <!-- item-->
                    <h6 class="dropdown-header">Welcome Anna!</h6>
                    <a class="dropdown-item" href="pages-profile.html">
                        <i class="mdi mdi-account-circle text-muted fs-16 align-middle me-1"></i> <span
                            class="align-middle">Profile</span>
                    </a>
                    <a class="dropdown-item" href="apps-chat.html">
                        <i class="mdi mdi-message-text-outline text-muted fs-16 align-middle me-1"></i> <span
                            class="align-middle">Messages</span>
                    </a>
                    <a class="dropdown-item" href="apps-tasks-kanban.html">
                        <i class="mdi mdi-calendar-check-outline text-muted fs-16 align-middle me-1"></i> <span
                            class="align-middle">Taskboard</span>
                    </a>
                    <a class="dropdown-item" href="pages-faqs.html">
                        <i class="mdi mdi-lifebuoy text-muted fs-16 align-middle me-1"></i> <span
                            class="align-middle">Help</span>
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="pages-profile.html">
                        <i class="mdi mdi-wallet text-muted fs-16 align-middle me-1"></i> <span
                            class="align-middle">Balance : <b>$5971.67</b></span>
                    </a>
                    <a class="dropdown-item" href="pages-profile-settings.html">
                        <span class="badge bg-success-subtle text-success mt-1 float-end">New</span><i
                            class="mdi mdi-cog-outline text-muted fs-16 align-middle me-1"></i> <span
                            class="align-middle">Settings</span>
                    </a>
                    <a class="dropdown-item" href="auth-lockscreen-basic.html">
                        <i class="mdi mdi-lock text-muted fs-16 align-middle me-1"></i> <span class="align-middle">
                            Lock
                            screen
                        </span>
                    </a>
                    <a class="dropdown-item" href="auth-logout-basic.html">
                        <i class="mdi mdi-logout text-muted fs-16 align-middle me-1"></i> <span class="align-middle"
                            data-key="t-logout">Logout</span>
                    </a>
                </div>
            </div>
            <div id="scrollbar">
                <div class="container-fluid">
                    <div id="two-column-menu">
                    </div>
                    <ul class="navbar-nav" id="navbar-nav">
                        <li class="menu-title"><span data-key="t-menu">Menu</span></li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="Admin" asp-action="Index">
                                <i class=" ri-pie-chart-line"></i> <span>Revenue Statistics</span>
                            </a>
                        </li>
                        <li class="nav-item"></li>
                        <a class="nav-link menu-link" asp-controller="Admin" asp-action="WithdrawList">
                            <i class="ri-exchange-dollar-line"></i> <span>Withdrawal Requests From Users</span>
                        </a>
                        </li>
                        <li class="nav-item"></li>
                        <a class="nav-link menu-link" asp-controller="Admin" asp-action="Managercomplant">
                            <i class="ri-error-warning-line"></i> <span>Order Complaint Reports From Seller</span>
                        </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="Admin" asp-action="ManagerUser">
                                <i class="ri-account-circle-line"></i> <span>User Accounts</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="Admin" asp-action="ManagementSeller">
                                <i class="ri-user-add-line"></i> <span>Seller Registration Requests</span>
                            </a>
                        </li>
                        <li class="nav-item"></li>
                        <a class="nav-link menu-link" asp-controller="Admin" asp-action="ViewStoreRegistration">
                            <i class="ri-file-add-line"></i> <span>Store Registration Requests</span>
                        </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="Admin" asp-action="ViewAdminStore">
                                <i class="ri-store-2-line"></i> <span>Store</span>
                            </a>
                        </li>
                        <li class="nav-item"></li>
                        <a class="nav-link menu-link" asp-controller="Admin" asp-action="ManagementReportStore">
                            <i class="ri-alert-line"></i> <span>Store Reports From User</span>
                        </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="Admin" asp-action="ViewCategories">
                                <i class="ri-folder-2-line"></i> <span>Categories</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="Admin" asp-action="ManagementRecipe">
                                <i class="ri-restaurant-2-line"></i> <span>Cooking Recipes</span>
                            </a>
                        </li>
                        <li class="nav-item"></li>
                        <a class="nav-link menu-link" asp-controller="Admin" asp-action="GetAllIngredientTag">
                            <i class=" ri-price-tag-3-line"></i> <span>Ingredient Tag</span>
                        </a>
                        </li>
                        <li class="nav-item"></li>
                        <a class="nav-link menu-link" asp-controller="Admin" asp-action="GetAllTypeOfDish">
                            <i class="ri-restaurant-line"></i> <span>Type of Dish</span>
                        </a>
                        </li>
                        <li class="nav-item"></li>
                        <a class="nav-link menu-link active" asp-controller="Admin" asp-action="ManagerVoucher">
                            <i class=" ri-coupon-2-line"></i> <span>Voucher</span>
                        </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="Admin" asp-action="Chat">
                                <i class="ri-chat-3-line"></i> <span>Chat</span>
                            </a>
                        </li>
                        <!--<li class="nav-item">
                            <a class="nav-link menu-link" href="">
                                <i class="ri-notification-2-line"></i> <span>Notifications</span>
                            </a>
                        </li> -->
                    </ul>
                </div>
            </div>
            <!-- Sidebar -->
        </div>
        <div class="sidebar-background"></div>
    </div>
    <!-- Left Sidebar End -->
    <!-- Vertical Overlay-->
    <div class="vertical-overlay"></div>

    <!-- ============================================================== -->
    <!-- Start right Content here -->
    <!-- ============================================================== -->
    <div class="main-content">

        <div class="page-content">
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div
                            class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                            <h4 class="mb-sm-0">Voucher List</h4>

                            @* <div class="page-title-right">
                                    <ol class="breadcrumb m-0">
                                        <li class="breadcrumb-item"><a href="javascript: void(0);">Tables</a></li>
                                        <li class="breadcrumb-item active">Listjs</li>
                                    </ol>
                                </div> *@

                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">Voucher Management</h4>
                            </div>

                            <div class="card-body">
                                <div class="listjs-table" id="voucherList">
                                    <div class="row g-4 mb-3">
                                        <div class="col-sm-auto">
                                            <div>
                                                <button type="button" class="btn btn-success add-btn" id="create-btn"
                                                    data-bs-toggle="modal" data-bs-target="#showModal">
                                                    <i class="ri-add-line align-bottom me-1"></i> Add
                                                </button>
                                                <button class="btn btn-soft-danger" onClick="deleteMultipleVoucher()">
                                                    <i class="ri-delete-bin-2-line"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-sm">
                                            <div class="d-flex justify-content-sm-end">
                                                <div class="search-box ms-2">
                                                    <input type="text" class="form-control search"
                                                        placeholder="Search...">
                                                    <i class="ri-search-line search-icon"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="listjs-table" id="voucherList" data-list='{
         "valueNames": [
             "code", "discountAmount", "discountType",
             "startDate", "expirationDate", "createdDate",
             "maxUsage", "currentUsage", "isActive"
         ],
         "page": 10,
         "pagination": true
     }'>

                                        <div class="table-responsive table-card mt-3 mb-1">
                                            <table class="table align-middle table-nowrap" id="voucherTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th scope="col" style="width: 50px;">
                                                            <input class="form-check-input" type="checkbox"
                                                                id="checkAll">
                                                        </th>
                                                        <th class="sort" data-sort="code">Code</th>
                                                        <th class="sort" data-sort="discountAmount">Discount</th>
                                                        <th class="sort" data-sort="discountType">Type</th>
                                                        <th class="sort" data-sort="startDate">Start</th>
                                                        <th class="sort" data-sort="expirationDate">End</th>
                                                        <th class="sort" data-sort="maxUsage">Max</th>
                                                        <th class="sort" data-sort="currentUsage">Used</th>
                                                        <th class="sort" data-sort="createdDate">Created</th>

                                                        <th class="sort" data-sort="isActive">Status</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="list form-check-all" id="voucherTableBody"></tbody>
                                            </table>
                                            <div class="noresult" style="display: none">
                                                <div class="text-center">
                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json"
                                                        trigger="loop" colors="primary:#121331,secondary:#08a88a"
                                                        style="width:75px;height:75px"></lord-icon>
                                                    <h5 class="mt-2">Sorry! No Result Found</h5>
                                                    <p class="text-muted mb-0">
                                                        We've searched more than 150+ Orders
                                                        We
                                                        did not find any orders for you search.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>


                                        <div class="d-flex justify-content-end">
                                            <div class="pagination-wrap hstack gap-2">
                                                <a class="page-item pagination-prev disabled"
                                                    href="javascript:void(0);">Previous</a>
                                                <ul class="pagination listjs-pagination mb-0"></ul>
                                                <a class="page-item pagination-next" href="javascript:void(0);">Next</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end row -->
                <script>
                                 document.addEventListener("DOMContentLoaded", function () {
                        const form = document.getElementById("voucherForm");
                        const modalElement = document.getElementById("showModal");
                        const modalTitle = modalElement.querySelector(".modal-title");
                        const modalInstance = new bootstrap.Modal(modalElement);
                        const tbody = document.getElementById("voucherTableBody");
                        let editingId = null;
                        let voucherToDeleteId = null;

                        // Initialize Flatpickr for date fields
                        flatpickr("#startDate", {
                            enableTime: true,
                            dateFormat: "Y-m-d H:i",
                            time_24hr: true
                        });

                        flatpickr("#expirationDate", {
                            enableTime: true,
                            dateFormat: "Y-m-d H:i",
                            time_24hr: true
                        });

                        // Function to toggle Max Discount field based on discount type
                        function toggleMaxDiscountField() {
                            const discountType = document.getElementById("discountType").value;
                            const maxDiscountField = document.getElementById("scope");
                            const maxDiscountLabel = maxDiscountField.closest('.col-md-6').querySelector('label');

                            if (discountType === "Percent") {
                                maxDiscountField.disabled = false;
                                maxDiscountField.required = true;
                                maxDiscountLabel.innerHTML = 'Max Discount <span class="text-danger">*</span>';
                            } else {
                                maxDiscountField.disabled = true;
                                maxDiscountField.required = false;
                                maxDiscountField.value = "";
                                maxDiscountLabel.innerHTML = 'Max Discount';
                                // Clear any error for this field
                                const errorSpan = maxDiscountField.nextElementSibling;
                                if (errorSpan && errorSpan.classList.contains("text-danger")) {
                                    errorSpan.style.display = "none";
                                    errorSpan.textContent = "";
                                }
                                maxDiscountField.classList.remove("is-invalid");
                            }
                        }

                        // Add event listener for discount type change
                        document.getElementById("discountType").addEventListener("change", toggleMaxDiscountField);

                        // Reset form function - IMPROVED
                        function resetForm() {
                            form.reset();
                            editingId = null; // Clear editing ID

                            // Reset all form fields to default values
                            document.getElementById("currentUsage").value = "0";
                            document.getElementById("discountType").value = "Fixed"; // Set default discount type
                            document.getElementById("isActive").value = "true"; // Set default active status

                            // Reset Max Discount field state
                            toggleMaxDiscountField();

                            // Update modal title to Create
                            modalTitle.textContent = "Add Voucher";

                            // Clear all error messages and validation states
                            form.querySelectorAll(".text-danger").forEach(e => {
                                e.style.display = "none";
                                e.textContent = "";
                            });
                            form.querySelectorAll("input, select").forEach(el => el.classList.remove("is-invalid"));

                            // Clear Flatpickr instances
                            const startDatePicker = document.getElementById("startDate")._flatpickr;
                            const expirationDatePicker = document.getElementById("expirationDate")._flatpickr;
                            if (startDatePicker) startDatePicker.clear();
                            if (expirationDatePicker) expirationDatePicker.clear();
                        }

                        // FIXED: Handle modal show event properly
                        modalElement.addEventListener("show.bs.modal", function (event) {
                            const button = event.relatedTarget; // Button that triggered the modal

                            // Check if this is a Create button (not Edit)
                            if (!button || !button.classList.contains("edit-item-btn")) {
                                // This is Create mode
                                resetForm();
                            }
                            // If it's Edit mode, the edit button handler will set the form data
                        });

                        // ADDED: Handle modal hide event to ensure clean state
                        modalElement.addEventListener("hide.bs.modal", function () {
                            // Reset editing state when modal is closed
                            if (editingId !== null) {
                                editingId = null;
                            }
                        });

                        // Helper function to show error
                        function showError(element, message) {
                            const errorSpan = element.nextElementSibling;
                            if (errorSpan && errorSpan.classList.contains("text-danger")) {
                                errorSpan.textContent = message;
                                errorSpan.style.display = "block";
                            }
                            element.classList.add("is-invalid");
                        }

                        // Enhanced validation function
                        function validateForm() {
                            let isValid = true;

                            // Clear previous errors
                            form.querySelectorAll(".text-danger").forEach(e => {
                                e.style.display = "none";
                                e.textContent = "";
                            });
                            form.querySelectorAll("input, select").forEach(el => {
                                el.classList.remove("is-invalid");
                            });

                            // Get form values
                            const code = document.getElementById("code").value.trim();
                            const discountAmount = document.getElementById("discountAmount").value.trim();
                            const startDate = document.getElementById("startDate").value.trim();
                            const expirationDate = document.getElementById("expirationDate").value.trim();
                            const minOrderValue = document.getElementById("minOrderValue").value.trim();
                            const maxDiscount = document.getElementById("scope").value.trim();
                            let currentUsage = document.getElementById("currentUsage").value.trim();
                            const maxUsage = document.getElementById("maxUsage").value.trim();
                            const discountType = document.getElementById("discountType").value;

                            // Set current usage to 0 if empty
                            if (!currentUsage || currentUsage === "") {
                                currentUsage = "0";
                                document.getElementById("currentUsage").value = "0";
                            }

                            // 1. Validate Code (required)
                            if (!code) {
                                showError(document.getElementById("code"), "Voucher code is required");
                                isValid = false;
                            } else if (code.length < 3) {
                                showError(document.getElementById("code"), "Voucher code must be at least 3 characters");
                                isValid = false;
                            }

                            // 2. Validate Discount Amount (required)
                            if (!discountAmount) {
                                showError(document.getElementById("discountAmount"), "Discount amount is required");
                                isValid = false;
                            } else {
                                const discountValue = parseFloat(discountAmount);
                                if (isNaN(discountValue) || discountValue <= 0) {
                                    showError(document.getElementById("discountAmount"), "Discount amount must be a positive number");
                                    isValid = false;
                                } else if (discountType === "Percent" && discountValue > 100) {
                                    showError(document.getElementById("discountAmount"), "Percentage discount cannot exceed 100%");
                                    isValid = false;
                                } else if (discountType === "Fixed" && discountValue > 1000000) {
                                    showError(document.getElementById("discountAmount"), "Fixed discount amount is too large");
                                    isValid = false;
                                }
                            }

                            // 3. Validate Start Date (required)
                            if (!startDate) {
                                showError(document.getElementById("startDate"), "Start date is required");
                                isValid = false;
                            }

                            // 4. Validate Expiration Date (required)
                            if (!expirationDate) {
                                showError(document.getElementById("expirationDate"), "Expiration date is required");
                                isValid = false;
                            }

                            // 5. Validate date range (if both dates are provided)
                            if (startDate && expirationDate) {
                                const start = new Date(startDate);
                                const end = new Date(expirationDate);

                                if (start >= end) {
                                    showError(document.getElementById("expirationDate"), "Expiration date must be after start date");
                                    isValid = false;
                                }

                                // Check if start date is in the past (optional validation)
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);
                                start.setHours(0, 0, 0, 0);

                                if (start < today) {
                                    showError(document.getElementById("startDate"), "Start date cannot be in the past");
                                    isValid = false;
                                }
                            }

                                               if (!minOrderValue || minOrderValue.trim() === "") {
                        showError(document.getElementById("minOrderValue"), "Please enter a minimum order value");
                        isValid = false;
                    } else {
                        const minValue = parseFloat(minOrderValue);
                        if (isNaN(minValue) || minValue < 0) {
                            showError(document.getElementById("minOrderValue"), "Minimum order value must be a non-negative number");
                            isValid = false;
                        }
                    }

                            // 7. Validate Max Discount (required for Percent type, optional for Fixed)
                            if (discountType === "Percent") {
                                if (!maxDiscount || maxDiscount === "") {
                                    showError(document.getElementById("scope"), "Maximum discount is required for percentage discount");
                                    isValid = false;
                                } else {
                                    const maxValue = parseFloat(maxDiscount);
                                    if (isNaN(maxValue) || maxValue <= 0) {
                                        showError(document.getElementById("scope"), "Maximum discount must be a positive number");
                                        isValid = false;
                                    }
                                }
                            } else if (discountType === "Fixed" && maxDiscount && maxDiscount !== "") {
                                const maxValue = parseFloat(maxDiscount);
                                if (isNaN(maxValue) || maxValue <= 0) {
                                    showError(document.getElementById("scope"), "Maximum discount must be a positive number");
                                    isValid = false;
                                }
                            }

                            // 8. Validate Current Usage (must be non-negative)
                            const currentValue = parseInt(currentUsage);
                            if (isNaN(currentValue) || currentValue < 0) {
                                showError(document.getElementById("currentUsage"), "Current usage must be a non-negative number");
                                isValid = false;
                            }

                            // 9. Validate Max Usage (optional but must be positive if provided)
                            if (maxUsage && maxUsage !== "") {
                                const maxValue = parseInt(maxUsage);
                                if (isNaN(maxValue) || maxValue <= 0) {
                                    showError(document.getElementById("maxUsage"), "Maximum usage must be a positive number");
                                    isValid = false;
                                }

                                // Check if current usage exceeds max usage
                                if (!isNaN(currentValue) && currentValue > maxValue) {
                                    showError(document.getElementById("currentUsage"), "Current usage cannot exceed maximum usage");
                                    isValid = false;
                                }
                            }

                            // 10. Business logic validation
                            if (discountType === "Percent" && discountAmount && maxDiscount) {
                                const discountValue = parseFloat(discountAmount);
                                const maxValue = parseFloat(maxDiscount);

                                if (!isNaN(discountValue) && !isNaN(maxValue)) {
                                    // For percentage discount, max discount should make sense
                                    if (minOrderValue) {
                                        const minValue = parseFloat(minOrderValue);
                                        if (!isNaN(minValue)) {
                                            const calculatedDiscount = (minValue * discountValue) / 100;
                                            if (calculatedDiscount > maxValue) {
                                                showError(document.getElementById("scope"), "Maximum discount is too low for the minimum order value");
                                                isValid = false;
                                            }
                                        }
                                    }
                                }
                            }

                            return isValid;
                        }

                        // Real-time validation for individual fields
                        function addRealTimeValidation() {
                            const inputs = form.querySelectorAll("input, select");

                            inputs.forEach(input => {
                                input.addEventListener("blur", function () {
                                    validateSingleField(this);
                                });
                            });
                        }

                        function validateSingleField(element) {
                            const errorSpan = element.nextElementSibling;
                            if (errorSpan && errorSpan.classList.contains("text-danger")) {
                                errorSpan.style.display = "none";
                                errorSpan.textContent = "";
                            }
                            element.classList.remove("is-invalid");

                            // Special handling for current usage - set to 0 if empty
                            if (element.id === "currentUsage" && (!element.value || element.value.trim() === "")) {
                                element.value = "0";
                            }

                            // Basic validation for required fields
                            if (element.hasAttribute("required") && !element.value.trim()) {
                                if (errorSpan) {
                                    errorSpan.textContent = "This field is required";
                                    errorSpan.style.display = "block";
                                }
                                element.classList.add("is-invalid");
                            }
                        }

                        // Form submission handler
                        form.addEventListener("submit", async function (e) {
                            e.preventDefault();

                            // Ensure current usage is set to 0 if empty
                            let currentUsageValue = document.getElementById("currentUsage").value.trim();
                            if (!currentUsageValue || currentUsageValue === "") {
                                currentUsageValue = "0";
                                document.getElementById("currentUsage").value = "0";
                            }

                            if (!validateForm()) return;

                            const data = {
                                ID: editingId,
                                Code: document.getElementById("code").value.trim(),
                                DiscountAmount: parseFloat(document.getElementById("discountAmount").value),
                                DiscountType: document.getElementById("discountType").value,
                                StartDate: document.getElementById("startDate").value,
                                ExpirationDate: document.getElementById("expirationDate").value,
                                Scope: document.getElementById("scope").value.trim(),
                                MaxUsage: document.getElementById("maxUsage").value ? parseInt(document.getElementById("maxUsage").value) : null,
                                CurrentUsage: parseInt(currentUsageValue),
                                MinOrderValue: document.getElementById("minOrderValue").value ? parseFloat(document.getElementById("minOrderValue").value) : null,
                                IsActive: document.getElementById("isActive").value === "true"
                            };

                            const url = editingId ? "/Admin/UpdateVoucher" : "/Admin/CreateVoucher";

                            try {
                                const res = await fetch(url, {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify(data)
                                });

                                const result = await res.json();

                                if (!res.ok || !result.success) {
                                    if (result.fieldErrors) {
                                        Object.entries(result.fieldErrors).forEach(([field, message]) => {
                                            const input = document.getElementById(field);
                                            if (input) showError(input, message);
                                        });
                                    } else {
                                        Swal.fire({
                                            icon: "error",
                                            title: "Error",
                                            text: result.error || "Unexpected error occurred."
                                        });
                                    }
                                    return;
                                } else {
                                    Swal.fire({
                                        title: editingId ? "Updated!" : "Created!",
                                        text: `Voucher has been successfully ${editingId ? "updated" : "created"}.`,
                                        icon: "success",
                                        confirmButtonText: "OK",
                                        customClass: { confirmButton: "btn btn-primary" },
                                        buttonsStyling: false
                                    });
                                }

                                modalInstance.hide();
                                await loadVouchers();
                                bindCheckAll();
                            } catch (err) {
                                Swal.fire({
                                    icon: "error",
                                    title: "Server Error",
                                    text: "Cannot connect to server."
                                });
                            }
                        });

                        // Load vouchers function
                        async function loadVouchers() {
                            try {
                                const res = await fetch("/Admin/GetAllVoucher");
                                const data = await res.json();
                                tbody.innerHTML = "";

                                function safeDate(str) {
                                    return (str && str.length >= 10) ? str : "";
                                }

                                data.forEach((item) => {
                                    const row = document.createElement("tr");
                                    row.innerHTML = `
                                        <td><input class="form-check-input" type="checkbox" name="chk_child" data-id="${item.id}"></td>
                                        <td class="code text-wrap">${item.code}</td>
                                        <td class="discountAmount text-wrap" style="min-width: 100px;">${item.discountAmount}</td>
                                        <td class="discountType text-wrap">${item.discountType}</td>
                                        <td class="startDate text-wrap">${safeDate(item.startDate)}</td>
                                        <td class="expirationDate text-wrap">${safeDate(item.expirationDate)}</td>
                                        <td class="maxUsage text-wrap" style="min-width: 100px;">${item.maxUsage || 'N/A'}</td>
                                        <td class="currentUsage text-wrap" style="min-width: 100px;">${item.currentUsage || 0}</td>
                                        <td class="createdDate text-wrap">${safeDate(item.createdDate)}</td>
                                        <td class="isActive">
                                            <span class="badge ${item.isActive ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'} text-uppercase">
                                                ${item.isActive ? 'Active' : 'Inactive'}
                                            </span>
                                        </td>
                                                           <td>
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary edit-item-btn" data-id="${item.id}" data-bs-toggle="modal" data-bs-target="#showModal">
                          <i class="ri-pencil-fill align-bottom me-1"></i>Edit
                        </button>
                        <button class="btn btn-sm btn-danger delete-item-btn" data-id="${item.id}" data-code="${item.code}" data-bs-toggle="modal" data-bs-target="#deleteRecordModal">
                          <i class="ri-eye-line align-bottom me-1"></i>Remove
                        </button>
                      </div>
                    </td>
                    `;
                                    tbody.appendChild(row);
                                });

                                // Initialize List.js for search and pagination
                                new List("voucherList", {
                                    valueNames: ["code", "discountAmount", "discountType", "startDate", "expirationDate", "createdDate", "maxUsage", "currentUsage", "isActive"],
                                    page: 5,
                                    pagination: true
                                });
                            } catch (error) {
                                console.error("Error loading vouchers:", error);
                                Swal.fire({
                                    icon: "error",
                                    title: "Error",
                                    text: "Failed to load vouchers."
                                });
                            }
                        }

                        // Bind check all functionality
                        function bindCheckAll() {
                            const checkAll = document.getElementById("checkAll");
                            if (checkAll) {
                                checkAll.addEventListener("change", function () {
                                    const isChecked = this.checked;
                                    document.querySelectorAll("input[name='chk_child']").forEach(cb => cb.checked = isChecked);
                                });
                            }
                        }

                        // IMPROVED: Event delegation for edit and delete buttons
                        document.addEventListener("click", async function (e) {
                            // Handle edit button click
                            if (e.target.classList.contains("edit-item-btn")) {
                                const id = e.target.dataset.id;
                                editingId = id; // Set editing ID

                                // Update modal title for edit
                                modalTitle.textContent = "Edit Voucher";

                                try {
                                    const res = await fetch(`/Admin/GetVoucher/${id}`);
                                    const v = await res.json();

                                    // Populate form with existing data
                                    document.getElementById("code").value = v.code || "";
                                    document.getElementById("discountAmount").value = v.discountAmount || "";
                                    document.getElementById("discountType").value = v.discountType || "Fixed";
                                    document.getElementById("startDate").value = v.startDate || "";
                                    document.getElementById("expirationDate").value = v.expirationDate || "";
                                    document.getElementById("scope").value = v.scope || "";
                                    document.getElementById("maxUsage").value = v.maxUsage || "";
                                    document.getElementById("currentUsage").value = v.currentUsage || "0";
                                    document.getElementById("minOrderValue").value = v.minOrderValue || "";
                                    document.getElementById("isActive").value = v.isActive ? "true" : "false";

                                    // Toggle Max Discount field based on discount type
                                    toggleMaxDiscountField();

                                    // Clear any existing errors
                                    form.querySelectorAll(".text-danger").forEach(e => {
                                        e.style.display = "none";
                                        e.textContent = "";
                                    });
                                    form.querySelectorAll("input, select").forEach(el => el.classList.remove("is-invalid"));

                                } catch (error) {
                                    console.error("Error fetching voucher:", error);
                                    Swal.fire({
                                        icon: "error",
                                        title: "Error",
                                        text: "Failed to load voucher data."
                                    });
                                }
                            }

                            // Handle delete button click
                            if (e.target.classList.contains("delete-item-btn")) {
                                voucherToDeleteId = e.target.dataset.id;
                                const code = e.target.dataset.code;
                                const previewElement = document.getElementById("voucherCodePreview");
                                if (previewElement) {
                                    previewElement.textContent = code;
                                }
                            }
                        });

                        // Delete single voucher
                        const deleteButton = document.getElementById("delete-record");
                        if (deleteButton) {
                            deleteButton.addEventListener("click", async function () {
                                if (!voucherToDeleteId) return;

                                try {
                                    const res = await fetch("/Admin/DeleteVoucher", {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({ id: voucherToDeleteId })
                                    });

                                    if (res.ok) {
                                        await loadVouchers();
                                        bindCheckAll();
                                        Swal.fire({
                                            title: "Deleted!",
                                            text: "Voucher has been successfully deleted.",
                                            icon: "success",
                                            confirmButtonText: "OK",
                                            customClass: { confirmButton: "btn btn-primary" },
                                            buttonsStyling: false
                                        });
                                    } else {
                                        Swal.fire({
                                            title: "Error",
                                            text: "Something went wrong while deleting the voucher.",
                                            icon: "error",
                                            confirmButtonText: "Close"
                                        });
                                    }

                                    voucherToDeleteId = null;
                                    const deleteModal = document.getElementById("deleteRecordModal");
                                    if (deleteModal) {
                                        bootstrap.Modal.getInstance(deleteModal)?.hide();
                                    }
                                } catch (error) {
                                    console.error("Error deleting voucher:", error);
                                    Swal.fire({
                                        icon: "error",
                                        title: "Error",
                                        text: "Failed to delete voucher."
                                    });
                                }
                            });
                        }

                        // Delete multiple vouchers function
                        window.deleteMultipleVoucher = async function () {
                            const checkboxes = document.querySelectorAll("input[name='chk_child']:checked");
                            if (checkboxes.length === 0) {
                                Swal.fire({
                                    title: "Please select at least one record",
                                    icon: "warning",
                                    confirmButtonText: "OK",
                                    customClass: { confirmButton: "btn btn-info" },
                                    buttonsStyling: false
                                });
                                return;
                            }

                            const ids = Array.from(checkboxes).map(cb => cb.getAttribute("data-id"));

                            Swal.fire({
                                title: "Are you sure?",
                                text: "You are about to delete multiple vouchers. This action cannot be undone.",
                                icon: "warning",
                                showCancelButton: true,
                                confirmButtonText: "Yes, delete them!",
                                cancelButtonText: "Cancel",
                                customClass: {
                                    confirmButton: "btn btn-danger",
                                    cancelButton: "btn btn-secondary"
                                },
                                buttonsStyling: false
                            }).then(async (result) => {
                                if (result.isConfirmed) {
                                    let allDeleted = true;
                                    let failedCount = 0;

                                    for (const id of ids) {
                                        try {
                                            const res = await fetch("/Admin/DeleteVoucher", {
                                                method: "POST",
                                                headers: { "Content-Type": "application/json" },
                                                body: JSON.stringify({ Id: id })
                                            });

                                            if (!res.ok) {
                                                allDeleted = false;
                                                failedCount++;
                                            }
                                        } catch (error) {
                                            console.error("Error deleting voucher:", error);
                                            allDeleted = false;
                                            failedCount++;
                                        }
                                    }

                                    if (allDeleted) {
                                        await loadVouchers();
                                        bindCheckAll();

                                        Swal.fire({
                                            title: "Deleted!",
                                            text: "Selected vouchers have been deleted.",
                                            icon: "success",
                                            confirmButtonText: "OK",
                                            customClass: { confirmButton: "btn btn-primary" },
                                            buttonsStyling: false
                                        });
                                    } else {
                                        const successCount = ids.length - failedCount;
                                        Swal.fire({
                                            title: failedCount === ids.length ? "Error" : "Partial Success",
                                            text: failedCount === ids.length
                                                ? "No vouchers could be deleted. Please try again."
                                                : `${successCount} vouchers deleted successfully, ${failedCount} failed.`,
                                            icon: failedCount === ids.length ? "error" : "warning",
                                            confirmButtonText: "Close"
                                        });

                                        if (successCount > 0) {
                                            await loadVouchers();
                                            bindCheckAll();
                                        }
                                    }
                                }
                            });
                        };

                        // Initialize real-time validation
                        addRealTimeValidation();

                        // Initialize Max Discount field state
                        toggleMaxDiscountField();

                        // Initialize the page
                        loadVouchers().then(bindCheckAll);
                    });
                </script>



                <div class="modal fade" id="showModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <form id="voucherForm">
                                <div class="modal-header bg-light">
                                    <h5 class="modal-title">Add / Edit Voucher</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Code</label>
                                        <input type="text" class="form-control" id="code" required />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Discount Amount</label>
                                        <input type="number" class="form-control" id="discountAmount" required />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Start Date</label>
                                        <input type="text" class="form-control flatpickr-input" id="startDate"
                                               data-provider="flatpickr" readonly />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Expiration Date</label>
                                        <input type="text" class="form-control flatpickr-input" id="expirationDate"
                                               data-provider="flatpickr" readonly />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Min Order Value</label>
                                        <input type="number" class="form-control" id="minOrderValue" />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Max Discount </label>
                                        <input type="text" class="form-control" id="scope" />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Current Usage</label>
                                        <input type="number" class="form-control" id="currentUsage" />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Max Usage</label>
                                        <input type="number" class="form-control" id="maxUsage" />
                                        <span class="text-danger" style="display:none"></span>
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label">Discount Type</label>
                                        <select class="form-select" id="discountType">
                                            <option value="Fixed">Fixed</option>
                                            <option value="Percent">Percent</option>
                                        </select>
                                        <span class="text-danger" style="display:none"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Active</label>
                                        <select class="form-select" id="isActive">
                                            <option value="true">Yes</option>
                                            <option value="false">No</option>
                                        </select>
                                        <span class="text-danger" style="display:none"></span>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-success">Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Modal -->
                <div class="modal fade zoomIn" id="deleteRecordModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                                    id="btn-close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mt-2 text-center">
                                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop"
                                        colors="primary:#f7b84b,secondary:#f06548"
                                        style="width:100px;height:100px"></lord-icon>
                                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                                        <h4>Are you Sure ?</h4>
                                        <p class="text-muted mx-4 mb-0">
                                            Are you sure you want to delete voucher <strong
                                                id="voucherCodePreview"></strong>?
                                        </p>

                                    </div>
                                </div>
                                <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                                    <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">
                                        Close
                                    </button>
                                    <button type="button" class="btn w-sm btn-danger " id="delete-record">
                                        Yes,
                                        Delete It!
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end modal -->

            </div>
            <!-- container-fluid -->
        </div>
        <!-- End Page-content -->
        @await Html.PartialAsync("_Footer_Admin_Seller")
    </div>
    <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->
    <!--start back-to-top-->
    <button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
        <i class="ri-arrow-up-line"></i>
    </button>
    <!--end back-to-top-->
    <!--preloader-->
    <div id="preloader">
        <div id="status">
            <div class="spinner-border text-primary avatar-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    </div>


    <!-- JAVASCRIPT -->
    <script src="~/assetsAdmin/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/assetsAdmin/libs/simplebar/simplebar.min.js"></script>
    <script src="~/assetsAdmin/libs/node-waves/waves.min.js"></script>
    <script src="~/assetsAdmin/libs/feather-icons/feather.min.js"></script>
    <script src="~/assetsAdmin/js/pages/plugins/lord-icon-2.1.0.js"></script>
    <script src="~/assetsAdmin/js/plugins.js"></script>

    <!-- list.js min js -->
    <script src="~/assetsAdmin/libs/list.js/list.min.js"></script>

    <!--list pagination js-->
    <script src="~/assetsAdmin/libs/list.pagination.js/list.pagination.min.js"></script>

    <!-- ecommerce-order init js -->
    <script src="~/assetsAdmin/js/pages/ecommerce-order.init.js"></script>

    <!-- Sweet Alerts js -->
    <script src="~/assetsAdmin/libs/sweetalert2/sweetalert2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- App js -->
    <script src="~/assetsAdmin/js/app.js"></script>
</body>


<!-- Mirrored from themesbrand.com/velzon/html/master/tables-listjs.html by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 26 Feb 2025 12:22:16 GMT -->

</html>