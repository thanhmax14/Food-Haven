@using System.Security.Claims
@{
    Layout = "_Layout";
}

<!doctype html>
<html lang="en" data-layout="vertical" data-topbar="light" data-sidebar="dark" data-sidebar-size="lg" data-sidebar-image="none" data-preloader="disable" data-theme="default" data-theme-colors="default">

<head>

    <meta charset="utf-8" />
    <title>Seller - Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Premium Multipurpose Admin & Dashboard Template" name="description" />
    <meta content="Themesbrand" name="author" />
    <!-- App favicon -->
    <link rel="shortcut icon" href="~/assetsAdmin/images/favicon.svg">

    <!-- glightbox css -->
    <link rel="stylesheet" href="~/assetsAdmin/libs/glightbox/css/glightbox.min.css">

    <!-- Layout config Js -->
    <script src="~/assetsAdmin/js/layout.js"></script>
    <!-- Bootstrap Css -->
    <link href="~/assetsAdmin/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <!-- Icons Css -->
    <link href="~/assetsAdmin/css/icons.min.css" rel="stylesheet" type="text/css" />
    <!-- App Css-->
    <link href="~/assetsAdmin/css/app.min.css" rel="stylesheet" type="text/css" />
    <!-- custom Css-->
    <link href="~/assetsAdmin/css/custom.min.css" rel="stylesheet" type="text/css" />
    <link href="~/assetsadmin/css/sian.css" rel="stylesheet" />
</head>

<body>

    <!-- Begin page -->
    <div id="layout-wrapper">

        @await Html.PartialAsync("_headeradmin")

<!-- removeNotificationModal -->
<div id="removeNotificationModal" class="modal fade zoomIn" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="NotificationModalbtn-close"></button>
            </div>
            <div class="modal-body">
                <div class="mt-2 text-center">
                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#f7b84b,secondary:#f06548" style="width:100px;height:100px"></lord-icon>
                    <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                        <h4>Are you sure ?</h4>
                        <p class="text-muted mx-4 mb-0">Are you sure you want to remove this Notification ?</p>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                    <button type="button" class="btn w-sm btn-light" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn w-sm btn-danger" id="delete-notification">Yes, Delete It!</button>
                </div>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
        <!-- ========== App Menu ========== -->
        <div class="app-menu navbar-menu">
            <!-- LOGO -->
            <div class="navbar-brand-box">
                <!-- Dark Logo-->
                <a href="/" class="logo logo-dark">
                    <span class="logo-sm">
                        <img src="~/assetsAdmin/images/logo-sm.svg" alt="" height="22">
                    </span>
                    <span class="logo-lg">
                        <img src="~/assetsAdmin/images/logo-dark.svg" alt="" height="35">
                    </span>
                </a>
                <!-- Light Logo-->
                <a href="/" class="logo logo-light">
                    <span class="logo-sm">
                        <img src="~/assetsAdmin/images/logo-sm.svg" alt="" height="22">
                    </span>
                    <span class="logo-lg">
                        <img src="~/assetsAdmin/images/logo-light.svg" alt="" height="35">
                    </span>
                </a>
                <button type="button" class="btn btn-sm p-0 fs-20 header-item float-end btn-vertical-sm-hover" id="vertical-hover">
                    <i class="ri-record-circle-line"></i>
                </button>
            </div>
    
            <div class="dropdown sidebar-user m-1 rounded">
                <button type="button" class="btn material-shadow-none" id="page-header-user-dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="d-flex align-items-center gap-2">
                        <img class="rounded header-profile-user" src="~/assetsAdmin/images/users/avatar-1.jpg" alt="Header Avatar">
                        <span class="text-start">
                            <span class="d-block fw-medium sidebar-user-name-text">Anna Adame</span>
                            <span class="d-block fs-14 sidebar-user-name-sub-text"><i class="ri ri-circle-fill fs-10 text-success align-baseline"></i> <span class="align-middle">Online</span></span>
                        </span>
                    </span>
                </button>
                <div class="dropdown-menu dropdown-menu-end">
                    <!-- item-->
                    <h6 class="dropdown-header">Welcome Anna!</h6>
                    <a class="dropdown-item" href="pages-profile.html"><i class="mdi mdi-account-circle text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Profile</span></a>
                    <a class="dropdown-item" href="apps-chat.html"><i class="mdi mdi-message-text-outline text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Messages</span></a>
                    <a class="dropdown-item" href="apps-tasks-kanban.html"><i class="mdi mdi-calendar-check-outline text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Taskboard</span></a>
                    <a class="dropdown-item" href="pages-faqs.html"><i class="mdi mdi-lifebuoy text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Help</span></a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="pages-profile.html"><i class="mdi mdi-wallet text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Balance : <b>$5971.67</b></span></a>
                    <a class="dropdown-item" href="pages-profile-settings.html"><span class="badge bg-success-subtle text-success mt-1 float-end">New</span><i class="mdi mdi-cog-outline text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Settings</span></a>
                    <a class="dropdown-item" href="auth-lockscreen-basic.html"><i class="mdi mdi-lock text-muted fs-16 align-middle me-1"></i> <span class="align-middle">Lock screen</span></a>
                    <a class="dropdown-item" href="auth-logout-basic.html"><i class="mdi mdi-logout text-muted fs-16 align-middle me-1"></i> <span class="align-middle" data-key="t-logout">Logout</span></a>
                </div>
            </div>
            <div id="scrollbar">
                <div class="container-fluid">
                    <div id="two-column-menu">
                    </div>
                    <ul class="navbar-nav" id="navbar-nav">
                        <li class="menu-title"><span data-key="t-menu">Menu</span></li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="seller" asp-action="index">
                                <i class=" ri-pie-chart-line"></i> <span>Revenue Statistics</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="seller" asp-action="ViewStore">
                                <i class="ri-store-2-line"></i> <span>Store</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="seller" asp-action="ViewProductList">
                                <i class="ri-restaurant-2-fill"></i> <span>Products</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="seller" asp-action="ManageOrder">
                                <i class="ri-file-copy-2-line"></i> <span>Sales History</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="seller" asp-action="ManagerComplant">
                                <i class="ri-error-warning-line"></i> <span>Order Complaintt</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="seller" asp-action="feedbacklist">
                                <i class="ri-question-answer-line"></i> <span>Feedback</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link" asp-controller="seller" asp-action="ManagerVoucher">
                                <i class="ri-price-tag-3-line"></i> <span>Vouchers</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link menu-link active" asp-controller="seller" asp-action="Chat">
                                <i class=" ri-chat-3-line"></i> <span>Chat</span>
                            </a>
                        </li>
                    </ul>
                </div>

            </div>
            <!-- Sidebar -->
        </div>
        <div class="sidebar-background"></div>
        </div>
        <!-- Left Sidebar End -->
        <!-- Vertical Overlay-->
        <div class="vertical-overlay"></div>

        <!-- ============================================================== -->
        <!-- Start right Content here -->
        <!-- ============================================================== -->
        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">
                    <div class="chat-wrapper d-lg-flex gap-1 mx-n4 mt-n4 p-1">
                        <div class="chat-leftsidebar minimal-border">
                            <div class="px-4 pt-4 mb-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-grow-1">
                                        <h5 class="mb-4">Chats</h5>
                                    </div>
                                    <div class="flex-shrink-0">
                                      @*   <div data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="bottom" title="Add Contact">

                                            <!-- Button trigger modal -->
                                            <button type="button" class="btn btn-soft-success btn-sm material-shadow-none">
                                                <i class="ri-add-line align-bottom"></i>
                                            </button>
                                        </div> *@
                                    </div>
                                </div>
                                <div class="search-box">
                                    <input type="text" class="form-control bg-light border-light" placeholder="Search here...">
                                    <i class="ri-search-2-line search-icon"></i>
                                </div>
                            </div> <!-- .p-4 -->

                            <ul class="nav nav-tabs nav-tabs-custom nav-success nav-justified" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#chats" role="tab">
                                        Chats
                                    </a>
                                </li>
                                @*  <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#contacts" role="tab">
                                Contacts
                                </a>
                                </li> *@
                            </ul>

                            <div class="tab-content text-muted">
                                <div class="tab-pane active" id="chats" role="tabpanel">
                                    <div class="chat-room-list pt-3" data-simplebar>
                                    <div class="d-flex align-items-center px-4 mb-2">
                                        <div class="flex-grow-1">
                                            <h4 class="mb-0 fs-11 text-muted text-uppercase">List Messages</h4>
                                        </div>
                                        <div class="flex-shrink-0">
                                            <div data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="bottom" title="New Message">
                                            </div>
                                        </div>
                                    </div>

                                        <div class="chat-message-list">

                                            <ul class="list-unstyled chat-list chat-user-list" id="userList">
                                            </ul>
                                        </div>

                                        <div class="d-flex align-items-center px-4 mt-4 pt-2 mb-2">
                                          
                                        </div>

                                        <div class="chat-message-list">

                                            <ul class="list-unstyled chat-list chat-user-list mb-0" id="channelList">
                                            </ul>
                                        </div>
                                        <!-- End chat-message-list -->
                                    </div>
                                </div>
                                <div class="tab-pane" id="contacts" role="tabpanel">
                                    <div class="chat-room-list pt-3" data-simplebar>
                                        <div class="sort-contact">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- end tab contact -->
                        </div>
                        <!-- end chat leftsidebar -->
                        <!-- Start User chat -->
                        <div class="user-chat w-100 overflow-hidden minimal-border">

                            <div class="chat-content d-lg-flex">
                                <!-- start chat conversation section -->
                                <div class="w-100 overflow-hidden position-relative">
                                    <!-- conversation user -->
                                    <div class="position-relative">


                                        <div class="position-relative" id="users-chat">
                                            <div class="p-3 user-chat-topbar">
                                                <div class="row align-items-center">
                                                    <div class="col-sm-4 col-8">
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 d-block d-lg-none me-3">
                                                                <a href="javascript: void(0);" class="user-chat-remove fs-18 p-1"><i class="ri-arrow-left-s-line align-bottom"></i></a>
                                                            </div>
                                                            <div class="flex-grow-1 overflow-hidden">
                                                                <div class="d-flex align-items-center">
                                                                    <div id="active-user-status" class="flex-shrink-0 chat-user-img online user-own-img align-self-center me-3 ms-0">
                                                                        <img src="assets/images/users/avatar-2.jpg" class="rounded-circle avatar-xs" alt="">
                                                                        <span class="user-status"></span>
                                                                    </div>
                                                                    <div class="flex-grow-1 overflow-hidden">
                                                                        <h5 class="text-truncate mb-0 fs-16"><a class="text-reset username" ></a></h5>
                                                                        <p id="active-user-status-text" class="text-truncate text-muted fs-14 mb-0 userStatus"><small></small></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-8 col-4">
                                                        <ul class="list-inline user-chat-nav text-end mb-0">
                                                            <li class="list-inline-item m-0">
                                                                <div class="dropdown">
                                                                    <button class="btn btn-ghost-secondary btn-icon material-shadow-none" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search icon-sm"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                                                    </button>
                                                                    <div class="dropdown-menu p-0 dropdown-menu-end dropdown-menu-lg" style="">
                                                                        <div class="p-2">
                                                                            <div class="search-box">
                                                                                <input type="text" class="form-control bg-light border-light" placeholder="Search here..." onkeyup="searchMessages()" id="searchMessage">
                                                                                <i class="ri-search-2-line search-icon"></i>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </li>

                                                         
                                                        </ul>
                                                    </div>
                                                </div>

                                            </div>
                                            <!-- end chat user head -->
                                            <div class="chat-conversation p-3 p-lg-4 " id="chat-conversation" data-simplebar>
                                                <div id="elmLoader">
                                                    <div class="spinner-border text-primary avatar-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </div>
                                                <ul class="list-unstyled chat-conversation-list" id="users-conversation">
                                                </ul>
                                                <!-- end chat-conversation-list -->
                                            </div>
                                            <div class="alert alert-warning alert-dismissible copyclipboard-alert px-4 fade show " id="copyClipBoard" role="alert">
                                                Message copied
                                            </div>
                                        </div>

                                        <div class="position-relative" id="channel-chat">
                                            <div class="p-3 user-chat-topbar">
                                                <div class="row align-items-center">
                                                    <div class="col-sm-4 col-8">
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 d-block d-lg-none me-3">
                                                                <a href="javascript: void(0);" class="user-chat-remove fs-18 p-1"><i class="ri-arrow-left-s-line align-bottom"></i></a>
                                                            </div>
                                                            <div class="flex-grow-1 overflow-hidden">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="flex-shrink-0 chat-user-img online user-own-img align-self-center me-3 ms-0">
                                                                        <img src="assets/images/users/avatar-2.jpg" class="rounded-circle avatar-xs" alt="">
                                                                    </div>
                                                                    <div class="flex-grow-1 overflow-hidden">
                                                                        <h5 class="text-truncate mb-0 fs-16"><a class="text-reset username" >Lisa Parker</a></h5>
                                                                        <p class="text-truncate text-muted fs-14 mb-0 userStatus"><small>24 Members</small></p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-sm-8 col-4">
                                                        <ul class="list-inline user-chat-nav text-end mb-0">
                                                            <li class="list-inline-item m-0">
                                                                <div class="dropdown">
                                                                    <button class="btn btn-ghost-secondary btn-icon" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                        <i data-feather="search" class="icon-sm"></i>
                                                                    </button>
                                                                    <div class="dropdown-menu p-0 dropdown-menu-end dropdown-menu-lg">
                                                                        <div class="p-2">
                                                                            <div class="search-box">
                                                                                <input type="text" class="form-control bg-light border-light" placeholder="Search here..." onkeyup="searchMessages()" id="searchMessage">
                                                                                <i class="ri-search-2-line search-icon"></i>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </li>

                                                            <li class="list-inline-item d-none d-lg-inline-block m-0">
                                                                <button type="button" class="btn btn-ghost-secondary btn-icon" data-bs-toggle="offcanvas" data-bs-target="#userProfileCanvasExample" aria-controls="userProfileCanvasExample">
                                                                    <i data-feather="info" class="icon-sm"></i>
                                                                </button>
                                                            </li>

                                                            <li class="list-inline-item m-0">
                                                                <div class="dropdown">
                                                                    <button class="btn btn-ghost-secondary btn-icon" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                        <i data-feather="more-vertical" class="icon-sm"></i>
                                                                    </button>
                                                                    <div class="dropdown-menu dropdown-menu-end">
                                                                        <a class="dropdown-item d-block d-lg-none user-profile-show" href="#"><i class="ri-user-2-fill align-bottom text-muted me-2"></i> View Profile</a>
                                                                        <a class="dropdown-item" href="#"><i class="ri-inbox-archive-line align-bottom text-muted me-2"></i> Archive</a>
                                                                        <a class="dropdown-item" href="#"><i class="ri-mic-off-line align-bottom text-muted me-2"></i> Muted</a>
                                                                        <a class="dropdown-item" href="#"><i class="ri-delete-bin-5-line align-bottom text-muted me-2"></i> Delete</a>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>

                                            </div>
                                            <!-- end chat user head -->
                                            <div class="chat-conversation p-3 p-lg-4" id="chat-conversation" data-simplebar>
                                                <ul class="list-unstyled chat-conversation-list" id="channel-conversation">
                                                </ul>
                                                <!-- end chat-conversation-list -->

                                            </div>
                                            <div class="alert alert-warning alert-dismissible copyclipboard-alert px-4 fade show " id="copyClipBoardChannel" role="alert">
                                                Message copied
                                            </div>
                                        </div>

                                        <!-- end chat-conversation -->

                                        <div class="chat-input-section p-3 p-lg-4">

                                            <form id="chatinput-form" enctype="multipart/form-data">
                                                <div class="row g-0 align-items-center">
                                                    <div class="col-auto">
                                                        <div class="chat-input-links me-2">
                                                            <div class="links-list-item">
                                                                <button type="button" class="btn btn-link text-decoration-none emoji-btn" id="emoji-btn">
                                                                    <i class="bx bx-smile align-middle"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="col">
                                                        <div class="chat-input-feedback">
                                                            Please Enter a Message
                                                        </div>
                                                        <input type="text" class="form-control chat-input bg-light border-light" id="chat-input" placeholder="Type your message..." autocomplete="off">
                                                    </div>
                                                    <div class="col-auto">
                                                        <div class="chat-input-links ms-2">
                                                            <div class="links-list-item">
                                                                <button type="submit" class="btn btn-success chat-send waves-effect waves-light">
                                                                    <i class="ri-send-plane-2-fill align-bottom"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </form>
                                        </div>

                                        <div class="replyCard">
                                            <div class="card mb-0">
                                                <div class="card-body py-3">
                                                    <div class="replymessage-block mb-0 d-flex align-items-start">
                                                        <div class="flex-grow-1">
                                                            <h5 class="conversation-name"></h5>
                                                            <p class="mb-0"></p>
                                                        </div>
                                                        <div class="flex-shrink-0">
                                                            <button type="button" id="close_toggle" class="btn btn-sm btn-link mt-n2 me-n3 fs-18">
                                                                <i class="bx bx-x align-middle"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end chat-wrapper -->

                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->
        @await Html.PartialAsync("_Footer_Admin_Seller")
        </div>
        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->

    <div class="offcanvas offcanvas-end border-0" tabindex="-1" id="userProfileCanvasExample">
        <!--end offcanvas-header-->
        <div class="offcanvas-body profile-offcanvas p-0">
            <div class="team-cover">
                <img src="~/assetsAdmin/images/small/img-9.jpg" alt="" class="img-fluid" />
            </div>
            <div class="p-1 pb-4 pt-0">
                <div class="team-settings">
                    <div class="row g-0">
                        <div class="col">
                            <div class="btn nav-btn">
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="user-chat-nav d-flex">
                                <button type="button" class="btn nav-btn favourite-btn active">
                                    <i class="ri-star-fill"></i>
                                </button>

                                <div class="dropdown">
                                    <a class="btn nav-btn" href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="ri-more-2-fill"></i>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-inbox-archive-line align-bottom text-muted me-2"></i>Archive</a></li>
                                        <li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-mic-off-line align-bottom text-muted me-2"></i>Muted</a></li>
                                        <li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-delete-bin-5-line align-bottom text-muted me-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <!--end col-->
            </div>
            <div class="p-3 text-center">
                <img src="~/assetsAdmin/images/users/avatar-2.jpg" alt="" class="avatar-lg img-thumbnail rounded-circle mx-auto profile-img">
                <div class="mt-3">
                    <h5 class="fs-16 mb-1"><a href="javascript:void(0);" class="link-primary username">Lisa Parker</a></h5>
                    <p class="text-muted"><i class="ri-checkbox-blank-circle-fill me-1 align-bottom text-success"></i>Online</p>
                </div>

                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn avatar-xs p-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Message">
                        <span class="avatar-title rounded bg-light text-body">
                            <i class="ri-question-answer-line"></i>
                        </span>
                    </button>

                    <button type="button" class="btn avatar-xs p-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Favourite">
                        <span class="avatar-title rounded bg-light text-body">
                            <i class="ri-star-line"></i>
                        </span>
                    </button>

                    <button type="button" class="btn avatar-xs p-0" data-bs-toggle="tooltip" data-bs-placement="top" title="Phone">
                        <span class="avatar-title rounded bg-light text-body">
                            <i class="ri-phone-line"></i>
                        </span>
                    </button>

                    <div class="dropdown">
                        <button class="btn avatar-xs p-0" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="avatar-title bg-light text-body rounded">
                                <i class="ri-more-fill"></i>
                            </span>
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-inbox-archive-line align-bottom text-muted me-2"></i>Archive</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-mic-off-line align-bottom text-muted me-2"></i>Muted</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0);"><i class="ri-delete-bin-5-line align-bottom text-muted me-2"></i>Delete</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="border-top border-top-dashed p-3">
                <h5 class="fs-15 mb-3">Personal Details</h5>
                <div class="mb-3">
                    <p class="text-muted text-uppercase fw-medium fs-12 mb-1">Number</p>
                    <h6>+(256) 2451 8974</h6>
                </div>
                <div class="mb-3">
                    <p class="text-muted text-uppercase fw-medium fs-12 mb-1">Email</p>
                    <h6>lisaparker@gmail.com</h6>
                </div>
                <div>
                    <p class="text-muted text-uppercase fw-medium fs-12 mb-1">Location</p>
                    <h6 class="mb-0">California, USA</h6>
                </div>
            </div>

            <div class="border-top border-top-dashed p-3">
                <h5 class="fs-15 mb-3">Attached Files</h5>

                <div class="vstack gap-2">
                    <div class="border rounded border-dashed p-2">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-xs">
                                    <div class="avatar-title bg-light text-secondary rounded fs-20">
                                        <i class="ri-folder-zip-line"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <h5 class="fs-13 mb-1"><a href="#" class="text-body text-truncate d-block">App pages.zip</a></h5>
                                <div class="text-muted">2.2MB</div>
                            </div>
                            <div class="flex-shrink-0 ms-2">
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-icon text-muted btn-sm fs-18 material-shadow-none"><i class="ri-download-2-line"></i></button>
                                    <div class="dropdown">
                                        <button class="btn btn-icon text-muted btn-sm fs-18 dropdown material-shadow-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="ri-more-fill"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded border-dashed p-2">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-xs">
                                    <div class="avatar-title bg-light text-secondary rounded fs-20">
                                        <i class="ri-file-ppt-2-line"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <h5 class="fs-13 mb-1"><a href="#" class="text-body text-truncate d-block">Velzon admin.ppt</a></h5>
                                <div class="text-muted">2.4MB</div>
                            </div>
                            <div class="flex-shrink-0 ms-2">
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-icon text-muted btn-sm fs-18 material-shadow-none"><i class="ri-download-2-line"></i></button>
                                    <div class="dropdown">
                                        <button class="btn btn-icon text-muted btn-sm fs-18 dropdown material-shadow-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="ri-more-fill"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded border-dashed p-2">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-xs">
                                    <div class="avatar-title bg-light text-secondary rounded fs-20">
                                        <i class="ri-folder-zip-line"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <h5 class="fs-13 mb-1"><a href="#" class="text-body text-truncate d-block">Images.zip</a></h5>
                                <div class="text-muted">1.2MB</div>
                            </div>
                            <div class="flex-shrink-0 ms-2">
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-icon text-muted btn-sm fs-18 material-shadow-none"><i class="ri-download-2-line"></i></button>
                                    <div class="dropdown">
                                        <button class="btn btn-icon text-muted btn-sm fs-18 dropdown material-shadow-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="ri-more-fill"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded border-dashed p-2">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <div class="avatar-xs">
                                    <div class="avatar-title bg-light text-secondary rounded fs-20">
                                        <i class="ri-image-2-line"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <h5 class="fs-13 mb-1"><a href="#" class="text-body text-truncate d-block">bg-pattern.png</a></h5>
                                <div class="text-muted">1.1MB</div>
                            </div>
                            <div class="flex-shrink-0 ms-2">
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-icon text-muted btn-sm fs-18 material-shadow-none"><i class="ri-download-2-line"></i></button>
                                    <div class="dropdown">
                                        <button class="btn btn-icon text-muted btn-sm fs-18 dropdown material-shadow-none" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="ri-more-fill"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#"><i class="ri-share-line align-bottom me-2 text-muted"></i> Share</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-bookmark-line align-bottom me-2 text-muted"></i> Bookmark</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="ri-delete-bin-line align-bottom me-2 text-muted"></i> Delete</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-2">
                        <button type="button" class="btn btn-danger">Load more <i class="ri-arrow-right-fill align-bottom ms-1"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <!--end offcanvas-body-->
    </div>
    <!--end offcanvas-->



    <!--start back-to-top-->
    <button onclick="topFunction()" class="btn btn-danger btn-icon" id="back-to-top">
        <i class="ri-arrow-up-line"></i>
    </button>
    <!--end back-to-top-->

    <!--preloader-->
    <div id="preloader">
        <div id="status">
            <div class="spinner-border text-primary avatar-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

   
    </div>

    <!-- JAVASCRIPT admin -->
    <script src="~/assetsAdmin/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="~/assetsAdmin/libs/simplebar/simplebar.min.js"></script>
    <script src="~/assetsAdmin/libs/node-waves/waves.min.js"></script>
    <script src="~/assetsAdmin/libs/feather-icons/feather.min.js"></script>
    <script src="~/assetsAdmin/js/pages/plugins/lord-icon-2.1.0.js"></script>
    <script src="~/assetsAdmin/js/plugins.js"></script>

    <!-- glightbox js -->
    <script src="~/assetsAdmin/libs/glightbox/js/glightbox.min.js"></script>

    <!-- fgEmojiPicker js -->
    <script src="~/assetsAdmin/libs/fg-emoji-picker/fgEmojiPicker.js"></script>

    <!-- chat init js -->
    <script src="~/js/site.js"></script>

    <!-- App js -->
    <script src="~/assetsAdmin/js/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-notify@latest/dist/simple-notify.min.js"></script>
</body>

</html>
<script>
    let connection = null;
    let typingTimer = null;
    let isTyping = false;
    const TYPING_TIMEOUT = 3000; // 3 seconds
    let users = [];




    (function () {
        'use strict';

        // Configuration
        const CONFIG = {
            baseUrl: window.location.origin,
            defaultUserImage: '/assetsAdmin/images/users/user-dummy-img.jpg',
            timeout: 10000,
            currentUserId: "@User.FindFirst(ClaimTypes.NameIdentifier)?.Value"
        };

        console.log(CONFIG.currentUserId + "ssss");
        let isReply = false;
        let replyToMessageId = null;
        let messageCounter = 0;
        let currentChatType = 'users';
        let currentChatId = 'users-chat';
        let shouldAutoClickFirstUser = true;
        const utils = {
            getCurrentTime: function () {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
                return `${displayHours < 10 ? '0' + displayHours : displayHours}:${displayMinutes} ${ampm}`;
            },

            escapeHtml: function (text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },

            showNotification: function (message, type = 'info') {
                console.log(`[${type.toUpperCase()}] ${message}`);
            },

            validateMessage: function (message) {
                return message && typeof message === 'object' && message.from_id && message.to_id;
            }
        };

        // API functions
        const api = {
            call: async function (endpoint, method = 'GET', data = null) {
                const fullUrl = endpoint.startsWith('http') ? endpoint : CONFIG.baseUrl + endpoint;

                const options = {
                    method: method,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    credentials: 'include'
                };

                if (data && method === 'POST') {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(fullUrl, options);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    document.getElementById("elmLoader").innerHTML = "";
                    return await response.json();
                } catch (error) {
                    console.error('API call failed:', error);

                    // 👉 Hiển thị thông báo lỗi với SweetAlert2
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi API',
                            text: error.message || 'Có lỗi xảy ra khi gọi API.',
                            confirmButtonText: 'OK'
                        });
                    }

                    throw error;
                }
            }
        };

        async function startChatWithUser(userId) {
            console.log('🎯 startChatWithUser được gọi với userId:', userId);

            // ✅ Ngăn không cho auto-click user đầu tiên
            shouldAutoClickFirstUser = false;

            const existingUser = document.querySelector(`#contact-id-${userId}`);
            if (!existingUser) {
                console.log('👤 User không tồn tại trong danh sách, đang thêm...');
                try {
                    const user = await api.call(`/Users/GetUserById?id=${userId}`);
                    if (!user) return;

                    const userHtml = `
                        <li id="contact-id-${user.id}" data-name="direct-message">
                            <a href="javascript:void(0);">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 chat-user-img online me-2">
                                        <div class="avatar-xxs">
                                            ${user.profile
                            ? `<img src="${user.profile}" class="rounded-circle img-fluid userprofile" alt="">`
                            : `<div class="avatar-title rounded-circle bg-primary text-white fs-10">${user.nickname || user.name.charAt(0)}</div>`}
                                            <span class="user-status"></span>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 overflow-hidden">
                                        <p class="text-truncate mb-0">${user.name}</p>
                                    </div>
                                </div>
                            </a>
                        </li>`;
                    document.getElementById('userList').insertAdjacentHTML('afterbegin', userHtml);
                    setupUserClickEvents(); // Gắn lại event click
                } catch (error) {
                    console.error('Lỗi khi thêm user:', error);
                    return;
                }
            }

            // ✅ Click vào user cụ thể
            setTimeout(() => {
                const userElement = document.querySelector(`#contact-id-${userId}`);
                if (userElement) {
                    console.log('✅ Đang click vào user:', userId);

                    // Remove active class from all users
                    document.querySelectorAll('#userList li.active').forEach(el => el.classList.remove('active'));

                    // Add active class to target user
                    userElement.classList.add('active');

                    // Trigger click event
                    userElement.querySelector('a')?.click();
                } else {
                    console.error('❌ Không tìm thấy user element sau khi thêm');
                }
            }, 100);
        }

        // Search functionality
        function searchMessages() {
            const searchTerm = document.getElementById('searchMessage')?.value?.toUpperCase() || '';
            const messageElements = document.querySelectorAll('#users-conversation li');

            messageElements.forEach(function (element) {
                const messageText = element.querySelector('p')?.textContent || '';
                element.style.display = messageText.toUpperCase().includes(searchTerm) ? '' : 'none';
            });
        }

        function createMessageContent(messageId, text, images = [], files = [], hasDropdown = false, repliedMessage = null) {
            let content = '<div class="ctext-wrap">';

            content += `<div class="ctext-wrap-content" id="${messageId}">`;

            // ✅ Nếu có repliedMessage, hiển thị block trả lời
            if (repliedMessage) {
                const replySenderName = repliedMessage.senderName || 'Unknown';
                const replyText = repliedMessage.msg || '[Image/File]';

                content += `
                        <div class="replymessage-block mb-0 d-flex align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="conversation-name">${utils.escapeHtml(replySenderName)}</h5>
                                <p class="mb-0">${utils.escapeHtml(replyText)}</p>
                            </div>
                        </div>
                    `;
            }

            // ✅ Nội dung chính
            if (text) {
                content += `<p class="mb-0 ctext-content mt-1">${utils.escapeHtml(text)}</p>`;
            }

            if (images.length > 0) {
                content += '<div class="message-img mb-0">';
                images.forEach(function (image) {
                    content += `
                            <div class="message-img-list">
                                <div>
                                    <a class="popup-img d-inline-block" href="${image}">
                                        <img src="${image}" alt="image" class="rounded border">
                                    </a>
                                </div>
                            </div>
                        `;
                });
                content += '</div>';
            }

            if (files.length > 0) {
                files.forEach(file => {
                    content += `
                            <div class="p-3 border-primary border rounded-3 mt-1">
                                <div class="d-flex align-items-center attached-file">
                                    <div class="avatar-sm me-3">
                                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle font-size-20">
                                            <i class="ri-attachment-2"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 overflow-hidden">
                                        <h5 class="font-size-14 mb-1">${file.name}</h5>
                                        <p class="text-muted font-size-13 mb-0">${file.size}</p>
                                    </div>
                                    <div class="ms-4">
                                        <a href="${file.url}" download class="text-muted"><i class="bx bxs-download"></i></a>
                                    </div>
                                </div>
                            </div>
                        `;
                });
            }

            content += `</div>`; // end of ctext-wrap-content

            // Dropdown actions
            if (hasDropdown) {
                content += `
                        <div class="dropdown align-self-start message-box-drop">
                            <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="ri-more-2-fill"></i>
                            </a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item reply-message" href="#"><i class="ri-reply-line me-2"></i>Reply</a>
                                <a class="dropdown-item copy-message" href="#"><i class="ri-file-copy-line me-2"></i>Copy</a>
                             
                            </div>
                        </div>
                    `;
            }

            content += '</div>'; // end of ctext-wrap
            return content;
        }

        function addMessage(chatType, messageText, isReplyMessage = false, messageId = null) {
            const conversationList = document.querySelector(`#${chatType} .chat-conversation-list`);

            if (!conversationList) {
                console.error('Conversation list not found');
                return;
            }
            const realId = messageId || 'temp-' + Date.now();

            let messageHtml = `<li class="chat-list right" id="chat-list-${realId}">
                    <div class="conversation-list">
                        <div class="user-chat-content">`;

            if (isReplyMessage) {
                const replyUserName = document.querySelector('.replyCard .replymessage-block .flex-grow-1 .conversation-name')?.textContent || 'Unknown';
                const replyMessage = document.querySelector('.replyCard .replymessage-block .flex-grow-1 .mb-0')?.textContent || '';

                messageHtml += `<div class="ctext-wrap">
                        <div class="ctext-wrap-content">
                            <div class="replymessage-block mb-0 d-flex align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="conversation-name">${utils.escapeHtml(replyUserName)}</h5>
                                    <p class="mb-0">${utils.escapeHtml(replyMessage)}</p>
                                </div>
                            </div>
                            <p class="mb-0 ctext-content mt-1">${utils.escapeHtml(messageText)}</p>
                        </div>
                        <div class="dropdown align-self-start message-box-drop">
                            <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="ri-more-2-fill"></i>
                            </a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item reply-message" href="#"><i class="ri-reply-line me-2"></i>Reply</a>
                                <a class="dropdown-item copy-message" href="#"><i class="ri-file-copy-line me-2"></i>Copy</a>
                                <a class="dropdown-item delete-item" href="#"><i class="ri-delete-bin-5-line me-2"></i>Delete</a>
                            </div>
                        </div>
                    </div>`;
            } else {
                messageHtml += createMessageContent(`msg-${messageCounter}`, messageText, [], [], true);
            }

            messageHtml += `</div>
                        <div class="conversation-name">
                            <small class="text-muted time">${utils.getCurrentTime()}</small>
                            <span class="text-success check-message-icon"><i class="bx bx-check"></i></span>
                        </div>
                    </div>
                </li>`;

            conversationList.insertAdjacentHTML('beforeend', messageHtml);
            setupMessageEvents();
            scrollToBottom(chatType);
        }

        // Event setup functions
        function setupMessageEvents() {
            // Delete message events
            document.querySelectorAll('.delete-item').forEach(function (element) {
                element.removeEventListener('click', handleDeleteMessage);
                element.addEventListener('click', handleDeleteMessage);
            });

            // Reply message events
            document.querySelectorAll('.reply-message').forEach(function (element) {
                element.removeEventListener('click', handleReplyMessage);
                element.addEventListener('click', handleReplyMessage);
            });

            // Copy message events
            document.querySelectorAll('.copy-message').forEach(function (element) {
                element.removeEventListener('click', handleCopyMessage);
                element.addEventListener('click', handleCopyMessage);
            });

            // Delete image events
            document.querySelectorAll('.delete-image').forEach(function (element) {
                element.removeEventListener('click', handleDeleteImage);
                element.addEventListener('click', handleDeleteImage);
            });
        }

        // Event handlers
        function handleDeleteMessage(event) {
            event.preventDefault();
            const messageElement = event.target.closest('.chat-list') || event.target.closest('.ctext-wrap');
            if (messageElement) {
                messageElement.remove();
            }
        }

        function handleReplyMessage(event) {
            event.preventDefault();

            const chatItem = event.target.closest('.chat-list');
            const messageText = chatItem?.querySelector('.ctext-content')?.textContent || '';
            const messageId = chatItem?.id?.replace('chat-list-', '');

            const replyCard = document.querySelector('.replyCard');
            const closeToggle = document.querySelector('#close_toggle');

            if (replyCard && messageText && messageId) {
                isReply = true;
                replyToMessageId = messageId;

                replyCard.classList.add('show');

                const replyMessageBlock = replyCard.querySelector('.replymessage-block .flex-grow-1 .mb-0');
                const replyUserBlock = replyCard.querySelector('.replymessage-block .flex-grow-1 .conversation-name');

                if (replyMessageBlock) replyMessageBlock.textContent = messageText;
                if (replyUserBlock) {
                    const userName = document.querySelector('.user-chat-topbar .username')?.textContent || 'Unknown';
                    const isLeftMessage = chatItem?.classList.contains('left');
                    replyUserBlock.textContent = isLeftMessage ? userName : 'You';
                }

                if (closeToggle) {
                    closeToggle.addEventListener('click', function () {
                        replyCard.classList.remove('show');
                        isReply = false;
                        replyToMessageId = null;
                    });
                }
            }
        }

        function handleCopyMessage(event) {
            event.preventDefault();
            const messageText = event.target.closest('.ctext-wrap')?.querySelector('.ctext-content')?.textContent || '';

            if (messageText && navigator.clipboard) {
                navigator.clipboard.writeText(messageText).then(function () {
                    const clipboardNotification = document.getElementById('copyClipBoard');
                    if (clipboardNotification) {
                        clipboardNotification.style.display = 'block';
                        setTimeout(function () {
                            clipboardNotification.style.display = 'none';
                        }, 1000);
                    }
                });
            }
        }

        function handleDeleteImage(event) {
            event.preventDefault();
            const imageElement = event.target.closest('.message-img-list') || event.target.closest('.message-img');
            if (imageElement) {
                imageElement.remove();
            }
        }

        function setupUserInteractions() {
            const userChatElements = document.querySelectorAll('.user-chat');
            const userListElements = document.querySelectorAll('.chat-user-list li a');
            const userChatRemoveElements = document.querySelectorAll('.user-chat-remove');

            // User chat show/hide
            userListElements.forEach(function (element) {
                element.addEventListener('click', function (event) {
                    userChatElements.forEach(function (chat) {
                        chat.classList.add('user-chat-show');
                    });

                    const activeUser = document.querySelector('.chat-user-list li.active');
                    if (activeUser) {
                        activeUser.classList.remove('active');
                    }

                    element.parentNode.classList.add('active');
                });
            });

            userChatRemoveElements.forEach(function (element) {
                element.addEventListener('click', function (event) {
                    userChatElements.forEach(function (chat) {
                        chat.classList.remove('user-chat-show');
                    });
                });
            });

            // Favorite button
            document.querySelectorAll('.favourite-btn').forEach(function (element) {
                element.addEventListener('click', function (event) {
                    element.classList.toggle('active');
                });
            });
        }

        // Chat history functions
        async function loadChatHistory(userId, otherId) {
            if (!userId || !otherId) {
                console.error('Invalid parameters for loading chat history');
                return;
            }

            try {
                const response = await api.call(`/Users/GetChatHistory?userId=${userId}&otherId=${otherId}`);
                const chatData = response?.chats || response?.data || response || [];

                if (!Array.isArray(chatData)) {
                    console.error('Invalid chat data format');
                    return;
                }

                const conversationElement = document.getElementById('users-conversation');
                if (!conversationElement) {
                    console.error('Conversation element not found');
                    return;
                }

                conversationElement.innerHTML = '';
                renderChatMessages(chatData);
                const userBadge = document.querySelector(`#contact-id-${otherId} .badge`);
                if (userBadge) {
                    userBadge.remove();
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                const conversationElement = document.getElementById('users-conversation');
                if (conversationElement) {
                    conversationElement.innerHTML = `
                            <li class="text-center p-3">
                                <div class="alert alert-warning">
                                    Unable to load chat history. Please check your connection and try again.
                                </div>
                            </li>
                        `;
                }
            }
        }

        function renderChatMessages(chatData) {
            const conversationElement = document.getElementById('users-conversation');
            conversationElement.innerHTML = '';

            chatData.forEach(function (message) {
                const isFromCurrentUser = message.from_id === CONFIG.currentUserId;
                const messageClass = isFromCurrentUser ? ' right' : ' left';

                const user = users.find(u => u.id === (isFromCurrentUser ? message.to_id : message.from_id)) || {
                    name: 'Unknown User',
                    profile: CONFIG.defaultUserImage
                };

                const repliedMessage = message.isReplied && typeof message.isReplied === 'string'
                    ? chatData.find(m => m.id === message.isReplied)
                    : null;

                const replyInfo = repliedMessage
                    ? {
                        senderName: users.find(u => u.id === repliedMessage.from_id)?.name || 'Unknown',
                        msg: repliedMessage.msg
                    }
                    : null;

                const messageHtml = `
                    <li class="chat-list${messageClass}" id="chat-list-${message.id}">
                        <div class="conversation-list">
                            ${!isFromCurrentUser ? `<div class="chat-avatar"><img src="${user.profile}" alt=""></div>` : ''}
                            <div class="user-chat-content">
                                ${createMessageContent(message.id, message.msg, message.has_images || [], message.has_files || [], message.has_dropDown, replyInfo)}
                                <div class="conversation-name">
                                    <small class="text-muted time">${message.datetime}</small>
                                      <span class="text-success check-message-icon">
            <i class="${message.is_read ? 'bx bx-check-double' : 'bx bx-check'}"></i>
        </span>
                                </div>
                            </div>
                        </div>
                    </li>
                `;

                conversationElement.innerHTML += messageHtml;
            });
            setupMessageEvents();

            scrollToBottom('users-chat');
            if (typeof GLightbox !== 'undefined') {
                GLightbox({ selector: '.popup-img' });
            }
        }

        // Scroll function
        function scrollToBottom(chatType) {
            setTimeout(function () {
                const chatElement = document.getElementById(chatType);
                const scrollWrapper = chatElement?.querySelector('#chat-conversation .simplebar-content-wrapper');
                const conversationList = chatElement?.querySelector('.chat-conversation-list');

                if (scrollWrapper && conversationList) {
                    const scrollHeight = conversationList.scrollHeight;
                    scrollWrapper.scrollTo({
                        top: scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }, 100);
        }

        // Chat type switching
        function switchChatType() {
            const usersChat = document.getElementById('users-chat');
            const channelChat = document.getElementById('channel-chat');

            if (currentChatType === 'users') {
                if (channelChat) channelChat.style.display = 'none';
                if (usersChat) usersChat.style.display = 'block';
            } else {
                if (usersChat) usersChat.style.display = 'none';
                if (channelChat) channelChat.style.display = 'block';
            }
        }

        // Initialize application
        async function initializeApp() {
            try {
                // Kiểm tra xem có cần mở chat với user cụ thể không
                const userIdToStart = localStorage.getItem('startChatUserId');
                if (userIdToStart) {
                    console.log('🎯 Phát hiện startChatUserId:', userIdToStart);
                    shouldAutoClickFirstUser = false;
                    localStorage.removeItem('startChatUserId');
                }

                // Load users
                const userList = await api.call('/Users/GetUserList');
                users = userList || [];

                // Render user list với trạng thái
                const userListContainer = document.getElementById('userList');
                if (userListContainer) {
                    userListContainer.innerHTML = '';
                    users.forEach(function (user) {
                        // ✅ Xác định trạng thái user
                        const statusClass = user.status === 'online' ? 'online' : 'offline';
                        const activeClass = user.id === 1 && shouldAutoClickFirstUser ? 'active' : '';

                        const userHtml = `<li id="contact-id-${user.id}" data-name="direct-message" class="${activeClass}">
                            <a href="javascript:void(0);" class="${user.messagecount ? 'unread-msg-user' : ''}">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 chat-user-img ${statusClass} align-self-center me-2 ms-0">
                                        <div class="avatar-xxs">
                                            ${user.profile ?
                                `<img src="${user.profile}" class="rounded-circle img-fluid userprofile" alt="">` :
                                `<div class="avatar-title rounded-circle bg-primary text-white fs-10">${user.nickname || user.name?.charAt(0) || 'U'}</div>`
                            }
                                            <span class="user-status"></span>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 overflow-hidden">
                                        <p class="text-truncate mb-0">${user.name || 'Unknown User'}</p>
                                        <small class="text-muted userStatus">${user.status === 'online' ? 'Active now' : `Active ${getTimeAgo(user.lastSeen || new Date())}`}</small>
                                    </div>
                                    ${user.messagecount ? `<div class="ms-auto"><span class="badge bg-dark-subtle text-body rounded p-1">${user.messagecount}</span></div>` : ''}
                                </div>
                            </a>
                        </li>`;
                        userListContainer.innerHTML += userHtml;
                    });
                }

                await initializeSignalR();
                requestNotificationPermission();

                // Setup interactions
                setupUserInteractions();
                setupUserClickEvents();
                setupChatForm();
                setupEmojiPicker();

                // Xử lý startChatUserId sau khi đã render user list
                if (userIdToStart) {
                    console.log('🚀 Bắt đầu chat với user:', userIdToStart);
                    await startChatWithUser(userIdToStart);
                } else if (shouldAutoClickFirstUser) {
                    // Chỉ auto-click user đầu tiên khi không có startChatUserId
                    const firstUser = document.querySelector('#userList li');
                    if (firstUser) {
                        firstUser.querySelector('a')?.click();
                    }
                }

                window.searchMessages = searchMessages;
                utils.showNotification('Chat application initialized successfully');

            } catch (error) {
                console.error('Error initializing application:', error);
                utils.showNotification('Error initializing chat application', 'error');
            }
        }

        function setupUserClickEvents() {
            document.querySelectorAll('#userList li').forEach(function (userElement) {
                userElement.addEventListener('click', function () {
                    currentChatType = 'users';
                    switchChatType();

                    const contactId = userElement.getAttribute('id')?.replace('contact-id-', '');
                    const otherUserId = contactId;
                    const userName = userElement.querySelector('.text-truncate')?.textContent || 'Unknown User';

                    console.log('👤 User clicked:', userName, 'ID:', otherUserId);

                    // Update UI
                    const userNameElement = document.querySelector('.user-chat-topbar .username');
                    if (userNameElement) userNameElement.textContent = userName;

                    const profileUserNameElement = document.querySelector('.profile-offcanvas .username');
                    if (profileUserNameElement) profileUserNameElement.textContent = userName;

                    // ✅ Cập nhật avatar và trạng thái của user đang chat
                    const userImg = userElement.querySelector('.userprofile')?.getAttribute('src');
                    const isOnline = userElement.querySelector('.chat-user-img')?.classList.contains('online');

                    // Update avatar trong header
                    const topbarAvatar = document.querySelector('#active-user-status img');
                    if (topbarAvatar && userImg) {
                        topbarAvatar.setAttribute('src', userImg);
                    }

                    // ✅ Cập nhật trạng thái ban đầu của user được chọn
                    const user = users.find(u => u.id === otherUserId);
                    if (user) {
                        const statusText = user.status === 'online' ? 'online' : `offline ${user.lastSeen || 'ago'}`;
                        updateActiveUserStatus(statusText, otherUserId);
                    } else {
                        // Mặc định là offline nếu không tìm thấy thông tin user
                        updateActiveUserStatus('offline ago', otherUserId);
                    }

                    // Handle reply card
                    if (isReply) {
                        isReply = false;
                        const replyCard = document.querySelector('.replyCard');
                        if (replyCard) replyCard.classList.remove('show');
                    }

                    // Update profile avatar
                    const profileAvatar = document.querySelector('.profile-offcanvas .avatar-lg');
                    if (profileAvatar && userImg) {
                        profileAvatar.setAttribute('src', userImg);
                    }

                    // Update chat avatars
                    document.querySelectorAll('#users-conversation .left .chat-avatar img').forEach(function (avatar) {
                        avatar.setAttribute('src', userImg || CONFIG.defaultUserImage);
                    });

                    // Load chat history
                    loadChatHistory(CONFIG.currentUserId, otherUserId);
                });
            });
        }

        function setupChatForm() {
            const chatForm = document.querySelector('#chatinput-form');
            const chatInput = document.querySelector('#chat-input');
            const chatFeedback = document.querySelector('.chat-input-feedback');

            if (chatForm && chatInput) {
                chatForm.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const messageText = chatInput.value.trim();
                    if (!messageText) {
                        if (chatFeedback) {
                            chatFeedback.classList.add('show');
                            setTimeout(function () {
                                chatFeedback.classList.remove('show');
                            }, 2000);
                        }
                        return;
                    }

                    // Get active user
                    const activeUser = document.querySelector('.chat-user-list li.active');
                    if (!activeUser) {
                        utils.showNotification('Please select a user to chat with', 'warning');
                        return;
                    }

                    const otherUserId = activeUser.getAttribute('id')?.replace('contact-id-', '');

                    // Prepare message data
                    const messageData = {
                        from_id: CONFIG.currentUserId,
                        to_id: otherUserId,
                        msg: messageText,
                        has_images: [],
                        has_files: []
                    };

                    // Nếu đang reply thì thêm ID của tin được reply
                    if (isReply && replyToMessageId) {
                        messageData.isReplied = replyToMessageId;
                    }

                    try {
                        // Send message to backend
                        const response = await api.call('/Users/SendMessage', 'POST', messageData);

                        // Add message to UI, dùng id thực tế từ backend
                        addMessage('users-chat', messageText, isReply, response.id);

                        // Reset form
                        chatInput.value = '';

                        // Close reply card if open
                        if (isReply) {
                            isReply = false;
                            replyToMessageId = null;
                            const closeToggle = document.getElementById('close_toggle');
                            if (closeToggle) closeToggle.click();
                        }

                    } catch (error) {
                        console.error('Error sending message:', error);
                        utils.showNotification('Failed to send message', 'error');
                    }
                });
            }
        }


        function setupEmojiPicker() {
            // Initialize emoji picker if FgEmojiPicker is available
            if (typeof FgEmojiPicker !== 'undefined') {
                try {
                    new FgEmojiPicker({
                        trigger: ['.emoji-btn'],
                        removeOnSelection: false,
                        closeButton: true,
                        position: ['top', 'right'],
                        preFetch: true,
                        dir: '/assetsAdmin/js/pages/plugins/json',
                        insertInto: document.querySelector('.chat-input')
                    });

                    const emojiBtn = document.getElementById('emoji-btn');
                    if (emojiBtn) {
                        emojiBtn.addEventListener('click', function () {
                            setTimeout(function () {
                                const emojiPicker = document.querySelector('.fg-emoji-picker');
                                if (emojiPicker) {
                                    const leftPos = parseInt(window.getComputedStyle(emojiPicker).left);
                                    if (!isNaN(leftPos)) {
                                        emojiPicker.style.left = (leftPos - 40) + 'px';
                                    }
                                }
                            }, 0);
                        });
                    }
                } catch (error) {
                    console.error('Error initializing emoji picker:', error);
                }
            }
        }

        // Auto-scroll setup
        function setupAutoScroll() {
            try {
                if (typeof SimpleBar !== 'undefined') {
                    const scrollEl = new SimpleBar(document.getElementById('chat-conversation'));
                    const conversationElement = document.getElementById('users-conversation');

                    if (scrollEl && conversationElement) {
                        scrollEl.getScrollElement().scrollTop = conversationElement.scrollHeight;
                    }
                }
            } catch (error) {
                console.error('Error setting up auto-scroll:', error);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', async function () {
                await initializeApp(); // ✅ load xong user list
                await setupAutoScroll();

                const userIdToStart = localStorage.getItem('startChatUserId');
                if (userIdToStart) {
                    isOpeningSpecificUser = true; // ✅ Đánh dấu đang mở người dùng cụ thể
                    localStorage.removeItem('startChatUserId');
                    await startChatWithUser(userIdToStart); // ✅ gọi đúng lúc
                }
            });
        } else {
            (async function () {
                await initializeApp();
                await setupAutoScroll();

                const userIdToStart = localStorage.getItem('startChatUserId');
                if (userIdToStart) {
                    localStorage.removeItem('startChatUserId');
                    await startChatWithUser(userIdToStart);
                }
            })();
        }
        // Initialize SignalR connection
        async function initializeSignalR() {
            try {
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/chathub")
                    .withAutomaticReconnect()
                    .configureLogging(signalR.LogLevel.Debug) // Thêm dòng này
                    .build();
                // Kiểm tra trạng thái kết nối
                connection.onreconnecting(() => {
                    console.log("🔄 SignalR reconnecting...");
                });

                connection.onreconnected(() => {
                    console.log("✅ SignalR reconnected");
                });

                connection.onclose(() => {
                    console.log("❌ SignalR connection closed");
                });

                connection.on("ReceiveMessage", function (messageData) {
                    console.log("📩 Received message:", messageData);

                    const activeUser = document.querySelector('.chat-user-list li.active');
                    const activeUserId = activeUser?.id?.replace('contact-id-', '');
                    console.log("💬 Đang chat với:", activeUserId, "Gửi từ:", messageData.from_id);

                    if (activeUserId === messageData.from_id) {
                        // Hiển thị tin nhắn ngay lập tức
                        addReceivedMessage(messageData);

                        // Đánh dấu đã đọc
                        connection.invoke("MarkAsRead", messageData.id, messageData.from_id);
                    } else {
                        // Cập nhật badge unread count
                        updateUnreadBadge(messageData.from_id);

                        // Hiển thị notification
                        showMessageNotification(messageData);
                    }
                });

                // Confirm tin nhắn đã gửi
                connection.on("MessageSent", function (messageData) {
                    console.log("✅ Message sent confirmed:", messageData);

                    // Cập nhật icon read status
                    const messageElement = document.querySelector(`#chat-list-${messageData.id}`);
                    if (messageElement) {
                        const checkIcon = messageElement.querySelector('.check-message-icon i');
                        if (checkIcon) {
                            checkIcon.className = 'bx bx-check';
                        }
                    }
                });

                connection.on("MessagesRead", function (messageIds, readBy) {
                    console.log("👁️ Messages read:", messageIds, "by:", readBy);

                    if (!Array.isArray(messageIds)) {
                        // Nếu là string, biến thành mảng
                        messageIds = [messageIds];
                    }

                    messageIds.forEach(messageId => {
                        // Nếu id dạng msg-..., thì lấy số thôi
                        const cleanId = messageId.replace(/^msg-/, '');

                        const messageElement = document.querySelector(`#chat-list-${cleanId}`);
                        if (messageElement) {
                            const checkIcon = messageElement.querySelector('.check-message-icon i');
                            if (checkIcon) {
                                checkIcon.className = 'bx bx-check-double';
                            }
                        }
                    });
                });



                // User bắt đầu typing
                connection.on("UserStartedTyping", function (userId, userName) {
                    console.log("⌨️ User started typing:", userName);

                    const activeUser = document.querySelector('.chat-user-list li.active');
                    const activeUserId = activeUser?.getAttribute('id')?.replace('contact-id-', '');

                    if (activeUserId === userId) {
                        showTypingIndicator(userName);
                    }
                });

                // User dừng typing
                connection.on("UserStoppedTyping", function (userId) {
                    console.log("🛑 User stopped typing:", userId);
                    hideTypingIndicator();
                });



                // Sửa phần SignalR event handlers
                connection.on("UserOnline", function (userId) {
                    console.log("🟢 User online:", userId);
                    updateUserStatus(userId, "online");
                });

                connection.on("UserOffline", function (userId, lastSeen) {
                    console.log("🔴 User offline:", userId, lastSeen);
                    const timeAgo = getTimeAgo(lastSeen);
                    updateUserStatus(userId, `offline ${timeAgo}`);
                });
                // Bắt đầu kết nối
                await connection.start();
                console.log("🚀 SignalR connected successfully");

            } catch (error) {
                console.error("❌ SignalR connection failed:", error);

                // Retry after 5 seconds
                setTimeout(initializeSignalR, 5000);
            }
        }

        // Thêm tin nhắn nhận được
        function addReceivedMessage(messageData) {
            const conversationList = document.querySelector('#users-chat .chat-conversation-list');
            if (!conversationList) return;

            // Tìm user info
            const user = users.find(u => u.id === messageData.from_id) || {
                name: messageData.senderName || 'Unknown User',
                profile: messageData.senderAvatar || CONFIG.defaultUserImage
            };

            const repliedMessage = messageData.isReplied && messageData.isReplied !== "00000000-0000-0000-0000-000000000000"
                ? { senderName: user.name, msg: "Original message" } // Có thể lấy từ cache hoặc API
                : null;

            console.log("📥 Adding received message:", messageData);
            const messageHtml = `
                    <li class="chat-list left" id="chat-list-${messageData.id}">
                        <div class="conversation-list">
                            <div class="chat-avatar">
                                <img src="${user.profile}" alt="">
                            </div>
                            <div class="user-chat-content">
                                ${createMessageContent(messageData.id, messageData.msg, messageData.has_images || [], [], true, repliedMessage)}
                                <div class="conversation-name">
                                    <small class="text-muted time">${messageData.datetime}</small>
                                </div>
                            </div>
                        </div>
                    </li>
                `;

            conversationList.insertAdjacentHTML('beforeend', messageHtml);
            setupMessageEvents();
            scrollToBottom('users-chat');

            // Play notification sound
            playNotificationSound();
        }

        // Hiển thị typing indicator
        function showTypingIndicator(userName) {
            // Xóa typing indicator cũ nếu có
            hideTypingIndicator();

            const conversationList = document.querySelector('#users-chat .chat-conversation-list');
            if (!conversationList) return;

            const typingHtml = `
                    <li class="chat-list left typing-indicator" id="typing-indicator">
                        <div class="conversation-list">
                            <div class="chat-avatar">
                                <div class="avatar-xxs">
                                    <div class="avatar-title rounded-circle bg-secondary text-white fs-10">
                                        ${userName.charAt(0)}
                                    </div>
                                </div>
                            </div>
                            <div class="user-chat-content">
                                <div class="ctext-wrap">
                                    <div class="ctext-wrap-content">
                                        <div class="typing-dots">
                                            <span></span>
                                            <span></span>
                                            <span></span>
                                        </div>
                                        <small class="text-muted">${userName} đang soạn tin...</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                `;

            conversationList.insertAdjacentHTML('beforeend', typingHtml);
            scrollToBottom('users-chat');
        }

        // Ẩn typing indicator
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        function updateUserStatus(userId, statusText) {
            // ✅ Cập nhật trong danh sách user
            const userElement = document.querySelector(`#contact-id-${userId}`);
            if (userElement) {
                const statusElement = userElement.querySelector('.chat-user-img');
                if (statusElement) {
                    // Cập nhật class trạng thái avatar
                    statusElement.className = statusElement.className.replace(/\b(online|offline)\b/g, '');
                    const isOnline = statusText.includes("online");
                    statusElement.classList.add(isOnline ? "online" : "offline");

                    // ✅ Tìm thẻ hiển thị văn bản trạng thái (bên cạnh avatar)
                    const parent = statusElement.closest('.d-flex.align-items-center');
                    if (parent) {
                        const userStatusText = parent.querySelector('.userStatus');
                        if (userStatusText) {
                            if (isOnline) {
                                userStatusText.textContent = "Active now";
                            } else {
                                const lastSeenTime = statusText.replace("offline ", "");
                                let timeAgo = getTimeAgo(lastSeenTime);
                                if (timeAgo.toLowerCase().includes("invalid")) timeAgo = "ago";

                                userStatusText.textContent = `Active ${timeAgo}`;
                            }
                        }
                    }
                }

            }

            // ✅ Kiểm tra xem có phải user đang chat không
            const activeUser = document.querySelector('.chat-user-list li.active');
            const activeUserId = activeUser?.getAttribute('id')?.replace('contact-id-', '');

            if (activeUserId === userId) {
                updateActiveUserStatus(statusText, userId);
            }
        }

        // Sửa function updateActiveUserStatus để nhận thêm userId
        function updateActiveUserStatus(statusText, userId = null) {
            // ✅ Cập nhật avatar class trong header chat
            const avatar = document.querySelector('#active-user-status');
            if (avatar) {
                avatar.className = avatar.className.replace(/\b(online|offline)\b/g, '');
                avatar.classList.add(statusText.includes("online") ? "online" : "offline");
            }

            // ✅ Cập nhật text trạng thái
            const statusTextElement = document.querySelector('#active-user-status-text small');
            if (statusTextElement) {
                if (statusText.includes("online")) {
                    statusTextElement.textContent = "Active now";
                } else {
                    // Hiển thị thời gian offline
                    let lastSeen = getTimeAgo(statusText.replace('offline ', ''));

                    // Nếu kết quả là 'không xác định' hoặc 'Invalid Date' → fallback
                    if (lastSeen === "không xác định" || lastSeen.toLowerCase().includes("invalid")) {
                        lastSeen = "ago";
                    }

                    statusTextElement.textContent = `Active ${lastSeen}`;

                }
            }
        }


        function updateUnreadBadge(userId) {
            const userElement = document.querySelector(`#contact-id-${userId}`);
            if (userElement) {
                let badge = userElement.querySelector('.badge');
                if (!badge) {
                    const badgeHtml = '<div class="ms-auto"><span class="badge bg-dark-subtle text-body rounded p-1">1</span></div>';
                    userElement.querySelector('.d-flex').insertAdjacentHTML('beforeend', badgeHtml);
                } else {
                    const currentCount = parseInt(badge.textContent) || 0;
                    badge.textContent = currentCount + 1;
                }
            }
        }


        function showMessageNotification(messageData) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const user = users.find(u => u.id === messageData.from_id);
                const notification = new Notification(user?.name || 'Tin nhắn mới', {
                    body: messageData.msg,
                    icon: user?.profile || CONFIG.defaultUserImage,
                    tag: messageData.from_id
                });

                notification.onclick = function () {
                    window.focus();
                    startChatWithUser(messageData.from_id);
                    notification.close();
                };
            }
        }


        function playNotificationSound() {
            try {
                const audio = new Audio('/audio/notify.mp3'); // Thêm file âm thanh
                audio.volume = 0.5;
                audio.play().catch(e => console.log('Cannot play notification sound:', e));
            } catch (error) {
                console.log('Notification sound not available');
            }
        }

        // Modify existing setupChatForm function
        function setupChatForm() {
            const chatForm = document.querySelector('#chatinput-form');
            const chatInput = document.querySelector('#chat-input');
            const chatFeedback = document.querySelector('.chat-input-feedback');

            if (chatForm && chatInput) {
                // Typing detection
                chatInput.addEventListener('input', function () {
                    const activeUser = document.querySelector('.chat-user-list li.active');
                    const activeUserId = activeUser?.getAttribute('id')?.replace('contact-id-', '');

                    if (activeUserId && connection) {
                        if (!isTyping) {
                            isTyping = true;
                            connection.invoke("StartTyping", activeUserId);
                        }

                        // Reset typing timer
                        clearTimeout(typingTimer);
                        typingTimer = setTimeout(() => {
                            if (isTyping) {
                                isTyping = false;
                                connection.invoke("StopTyping", activeUserId);
                            }
                        }, TYPING_TIMEOUT);
                    }
                });

                // Stop typing when focus lost
                chatInput.addEventListener('blur', function () {
                    const activeUser = document.querySelector('.chat-user-list li.active');
                    const activeUserId = activeUser?.getAttribute('id')?.replace('contact-id-', '');

                    if (activeUserId && connection && isTyping) {
                        isTyping = false;
                        clearTimeout(typingTimer);
                        connection.invoke("StopTyping", activeUserId);
                    }
                });

                chatForm.addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const messageText = chatInput.value.trim();
                    if (!messageText) {
                        if (chatFeedback) {
                            chatFeedback.classList.add('show');
                            setTimeout(function () {
                                chatFeedback.classList.remove('show');
                            }, 2000);
                        }
                        return;
                    }

                    // Stop typing
                    const activeUser = document.querySelector('.chat-user-list li.active');
                    const otherUserId = activeUser?.getAttribute('id')?.replace('contact-id-', '');

                    if (otherUserId && connection && isTyping) {
                        isTyping = false;
                        clearTimeout(typingTimer);
                        connection.invoke("StopTyping", otherUserId);
                    }

                    if (!activeUser) {
                        utils.showNotification('Please select a user to chat with', 'warning');
                        return;
                    }

                    const messageId = generateGuid();

                    // Prepare message data
                    const messageData = {
                        id: messageId,
                        from_id: CONFIG.currentUserId,
                        to_id: otherUserId,
                        msg: messageText,
                        has_images: [],
                        has_files: [],
                        isReplied: isReply && replyToMessageId ? replyToMessageId : null
                    };

                    try {
                        // Add message to UI immediately (optimistic UI)
                        addMessage('users-chat', messageText, isReply, messageId);

                        // Send via SignalR if connected, otherwise fallback to HTTP
                        if (connection && connection.state === signalR.HubConnectionState.Connected) {
                            await connection.invoke("SendMessage", otherUserId, messageText, messageId, messageData.isReplied);
                        } else {
                            // Fallback to HTTP API
                            await api.call('/Users/SendMessage', 'POST', messageData);
                        }

                        // Reset form
                        chatInput.value = '';

                        // Close reply card if open
                        if (isReply) {
                            isReply = false;
                            replyToMessageId = null;
                            const closeToggle = document.getElementById('close_toggle');
                            if (closeToggle) closeToggle.click();
                        }

                    } catch (error) {
                        console.error('Error sending message:', error);
                        utils.showNotification('Failed to send message', 'error');
                    }
                });
            }
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }


    })();
    function generateGuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
           function getTimeAgo(lastSeenString) {
        if (!lastSeenString) return "a moment ago";

        const lastSeen = new Date(lastSeenString);
        if (isNaN(lastSeen)) return "a moment ago"; // ⬅️ ✅ fallback here as well

        const now = new Date();
        const diffMs = now - lastSeen;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);

        if (diffSec < 60) return "just now";
        if (diffMin < 60) return `${diffMin} minute(s) ago`;
        if (diffHour < 24) return `${diffHour} hour(s) ago`;
        if (diffDay < 7) return `${diffDay} day(s) ago`;

        return lastSeen.toLocaleDateString('en-US');
    }


</script>