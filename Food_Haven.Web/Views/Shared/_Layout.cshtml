<!DOCTYPE html>
<html lang="en">
<head>
    @Html.Raw("<link href='https://cdn.jsdelivr.net/npm/@flaticon/flaticon-uicons/css/all/all.css' rel='stylesheet'>")
    <link href="~/assets/simple-notify/simple-notify.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
            @RenderBody()
    <script src="~/assets/cute-alert/cute-alert.js"></script>
    <script src="~/assets/sweetalert2/sweetalert2.js"></script>
    <link rel="stylesheet" href="~/assets/cute-alert/style.css" />
    <link href="~/assets/sweetalert2/default.css" rel="stylesheet" />
    <script src="~/assets/simple-notify/simple-notify.min.js"></script>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-notify@latest/dist/simple-notify.min.js"></script>
    <script src="~/js/cart.js"></script>
  <script>
    $(document).ready(function () {
        // Lấy số dư (balance) nếu cần
        function getBalance() {
            $.ajax({
                url: '/Home/GetBalance',
                type: 'POST',
                dataType: 'json',
                success: function (response) {
                    if (response.msg) {
                        $("#balance-display").text(response.msg);
                    } else {
                        console.error(response.msg);
                    }
                },
                error: function () {
                    console.error("Lỗi khi lấy số dư.");
                }
            });
        }

        // Lấy stock theo variantId và cập nhật #stock-display
        function getStock() {
            var variantId = $("#selectedVariantId").val();
            if (!variantId) {
                console.warn("variantId chưa được chọn hoặc trống.");
                $("#stock-display").text("N/A");
                return;
            }

            $.ajax({
                url: "/Home/GetVariantPrice",
                type: "GET",
                data: { variantId: variantId },
                dataType: "json",
                success: function (data) {
                    if (data && data.stock !== undefined) {
                        // Cập nhật stock vào span
                        $("#stock-display").text(data.stock);
                    } else {
                        console.warn("Dữ liệu stock không hợp lệ:", data);
                        $("#stock-display").text("N/A");
                    }
                },
                error: function () {
                    console.error("Lỗi khi lấy thông tin stock.");
                    $("#stock-display").text("Lỗi");
                }
            });
        }

        // Gọi lần đầu khi trang load
        getBalance();
        getStock();

        // Cập nhật lại stock mỗi 10 giây
        setInterval(function () {
            getBalance();
            getStock();
        }, 10000);

        // Nếu muốn khi user chọn variant khác thì gọi lại getStock ngay lập tức
        $("#selectedVariantId").on("change", function() {
            getStock();
        });
    });
</script>



    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');
        const token = urlParams.get('token');

        if (userId && token) {
            $.ajax({
                url: '/Home/ConfirmEmail',
                type: 'GET',
                data: {
                    userId: userId,
                    token: token
                },
                success: function (data) {
                    Swal.fire({
                        icon: data.success ? 'success' : 'error',
                        title: data.success ? 'Thành công' : 'Thất bại',
                        text: data.message
                    }).then(() => {
                        // Xóa tham số userId và token khỏi URL mà không reload trang
                        const cleanUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                    });
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Đã xảy ra lỗi trong quá trình xác nhận.'
                    }).then(() => {
                        const cleanUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                    });
                }
            });
        } 
    </script>
</body>
</html>
