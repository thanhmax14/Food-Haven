<!DOCTYPE html>
<html lang="en">

<head>
   
    <style>
        .chat-toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2f3542;
            color: white;
            padding: 14px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 9999;
            transition: transform 0.3s ease;
        }

            .chat-toast-notification:hover {
                transform: scale(1.05);
                background-color: #1e272e;
            }
    </style>
</head>

<body>
    @RenderBody()
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    
    <script>
        $(document).ready(function () {
            // Lấy số dư (balance) nếu cần
            function getBalance() {
                $.ajax({
                    url: '/Home/GetBalance',
                    type: 'POST',
                    dataType: 'json',
                    success: function (response) {
                        if (response.msg) {
                            $("#balance-display").text(response.msg);
                        } else {
                            console.error(response.msg);
                        }
                    },
                    error: function () {
                        console.error("Lỗi khi lấy số dư.");
                    }
                });
            }

            /*  function getStock() {

                  var variantId = $("#selectedVariantId").val();

                  // Nếu chưa có variant được chọn → tự động chọn option đầu tiên
                  if (!variantId) {
                      var firstOption = $("#selectedVariantId option:first").val();
                      $("#selectedVariantId").val(firstOption);
                      variantId = firstOption;
                  }

                  $.ajax({
                      url: "/Home/GetVariantPrice",
                      type: "GET",
                      data: { variantId: variantId },
                      dataType: "json",
                      success: function (data) {
                          if (data && data.stock != null && !isNaN(data.stock)) {
                              $("#stock-display").text(data.stock);

                              if (data.price != null && !isNaN(data.price)) {
                                  var formattedPrice = data.price.toLocaleString("vi-VN", {
                                      style: "currency",
                                      currency: "VND"
                                  });
                                  $("#price-display").text(formattedPrice);
                              } else {
                                  console.warn("Giá không hợp lệ:", data);
                                  $("#price-display").text("0 đ");
                              }
                          } else {
                              console.warn("Dữ liệu stock không hợp lệ:", data);
                              $("#stock-display").text("0");
                              $("#price-display").text("0 đ");
                          }
                      },
                      error: function () {
                          console.error("Lỗi khi lấy thông tin từ server.");
                          $("#stock-display").text("0");
                          $("#price-display").text("0 đ");
                      }
                  });
              }  */


            // Gọi lần đầu khi trang load
            getBalance();
            /*  getStock(); */

            // Cập nhật lại stock mỗi 10 giây
            setInterval(function () {
                getBalance();
                /*  getStock(); */
            }, 10000);

            // Nếu muốn khi user chọn variant khác thì gọi lại getStock ngay lập tức
            /*      $("#selectedVariantId").on("change", function () {
                     getStock();
                 });
                 */
        });
    </script>

    <script>
        function goToChat(userId) {
            localStorage.setItem('startChatUserId', userId);
            console.log('Đã lưu userId vào localStorage:', userId);
            setTimeout(function () {
                window.location.href = '/users/chatlist';
            }, 100);
        }
    </script>
    <script>
        const currentUserId = '@User.FindFirst("sub")?.Value';

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub")
            .build();

        connection.start().then(() => {
            console.log("✅ SignalR connected.");
        }).catch(err => console.error(err.toString()));
        connection.on("ReceiveMessage", function (message) {
            console.log("📩 New message received:", message);
            if (!window.location.pathname.includes("/Chat")) {
                showToastNotification(message.senderName + " vừa gửi: " + message.msg, message.from_id);
                const audio = new Audio('/audio/notify.mp3');
                audio.play().catch(e => console.warn("🔇 Notification sound blocked:", e));
            }
        });

        function showToastNotification(text, userId) {
            const toast = document.createElement("div");
            toast.className = "chat-toast-notification";
            toast.textContent = text;

            // Khi người dùng click vào toast
            toast.addEventListener("click", () => {
                goToChat(userId);
            });

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 7000);
        }
    </script>


</body>

</html>
